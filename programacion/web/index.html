<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/basic.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <title>Chamous</title>
    <script type="module">
        const form = document.querySelector('form');
        const registerForm = document.getElementById('registerForm');
        const forgotForm = document.getElementById('forgotForm');
        const login = document.getElementById('login');
        const register = document.getElementById('register-button');
        const changePassword = document.getElementById('change-password');

        login.addEventListener('click', async () => {
            fetch('/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    usernameLogin: document.getElementById('username').value,
                    passwordLogin: document.getElementById('password').value
                })
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                    if (data.isFirstLog === 1) {
                        window.location.href = '/intro'
                    } else if (data.isFirstLog === 0) {
                        window.location.href = '/game'
                    } else {
                        alert('User or password incorrects')
                    }
                })
                .catch(error => {
                    console.error('Error', error)
                });
        })

        register.addEventListener('click', async () => {
            console.log('Hola')
            fetch('/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: document.getElementById('name').value,
                    surname: document.getElementById('surname').value,
                    email: document.getElementById('email').value,
                    username: document.getElementById('usernameR').value,
                    password: document.getElementById('passwordR').value,
                    rpassword: document.getElementById('rpasswordR').value
                })
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                    if (data.message === 'registered') {
                        window.location.href = '/'
                    } else if (data.message === 'samePwd') {
                        alert('Passwords do not match')
                        const password = document.getElementById('passwordR');
                        const rpassword = document.getElementById('rpasswordR');
                        password.value = ''
                        rpassword.value = ''
                    } else if (data.message === 'userExists') {
                        alert('User already taken')
                    } else if (data.message === 'emailExists') {
                        alert('Email already taken')
                    } else {
                        alert('Error')
                    }
                })
                .catch(error => {
                    console.error('Error: ', error)
                });
        })

        changePassword.addEventListener('click', async () => {
            fetch('/forgot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: document.getElementById('emailF').value,
                    newPassword: document.getElementById('newPassword').value,
                    newPasswordR: document.getElementById('newPasswordR').value
                })
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                    if (data.message === 'changed') {
                        window.location.href = '/'
                    } else if (data.message === 'samePwd') {
                        alert('Passwords do not match')
                        const newPassword = document.getElementById('newPassword');
                        const newPasswordR = document.getElementById('newPasswordR');
                        newPassword.value = ''
                        newPasswordR.value = ''
                    } else if (data.message === 'emailNotExists') {
                        alert('Email does not exist')
                    } else if (data.message === 'pswAlreadyExists') {
                        alert('You cannot use the same password as before')
                        const newPassword = document.getElementById('newPassword');
                        const newPasswordR = document.getElementById('newPasswordR');
                        newPassword.value = ''
                        newPasswordR.value = ''
                    } else {
                        alert('Error')
                    }
                })
                .catch(error => {
                    console.error('Error: ', error)
                });
        })

        form.addEventListener('submit', (e) => {
            e.preventDefault();
        });

        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
        });

        forgotForm.addEventListener('submit', (e) => {
            e.preventDefault();
        });

    </script>
</head>
<body>
   
   <audio src="img/[Non Copyrighted Music] @ScottBuckley - Phoenix [Epic].mp3" autoplay loop></audio>
    <div id="fullscreenIcon" class="icon">
        <i class='bx bx-fullscreen'></i>
        <i class='bx bx-exit-fullscreen'></i>
    </div>
    <div class="container" id="divLogin">
        <h1>Start session and travel to Chamous</h1>
        <p>Log In and Continue your adventure</p>
        <form class="form">
            <input type="text" name="username" id="username" placeholder="Username">
            <input type="password" name="password" id="password" placeholder="Password">
            <button type="submit" id="login">Log In</button>
            <button type="submit" class="register" onclick="showRegister()">Register</button>
            <button type="submit"  onclick="showforgot()" id="bfpassword">Forgot your password?</button>
        </form>
    </div>

    <div class="container" id="register">
        
        <h1>Register</h1>
        <p>Register and start your adventure</p>
        <form class="form" id="registerForm">
            <input type="text" name="name" id="name" placeholder="Name" required>
            <input type="text" name="surname" id="surname" placeholder="surname" required>
            <input type="text" name="email" id="email" placeholder="email" required>
            <input type="text" name="usernameR" id="usernameR" placeholder="Username" required>
            <input type="password" name="passwordR" id="passwordR" placeholder="Password" required>
            <input type="password" name="rpasswordR" id="rpasswordR" placeholder="Repeat Password" required>
            <button type="submit" id="register-button">Register</button>
        </form>
    </div>


    <div class="container" id="forgot">
        <i id="atras2" class='bx bx-arrow-back'></i>
        <script>
            document.getElementById('atras2').addEventListener('click', () => {
                document.getElementById('forgot').style.display = 'none';
                document.getElementById('divLogin').style.display = 'block';
            })
        </script>
        <h1>Forgot your password?</h1>
        <p>Enter your new Password</p>
        <form class="form" id="forgotForm">
            <input type="text" id="emailF" placeholder="Email" required>
            <input type="password" name="newPassword" id="newPassword" placeholder="Password" required>
            <input type="password" name="newPasswordR" id="newPasswordR" placeholder="Repeat Password" required>
            <button type="submit" id="change-password">Change Password</button>
        </form>


    <script src="js/index.js"></script>

</body>
</html>