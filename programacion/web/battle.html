<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle - Chamous</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="css/combat.css">
    <link rel='icon' href='img/logoC.png'>
    <script type="module">
        import { io } from 'https://cdn.socket.io/4.7.5/socket.io.esm.min.js'

        const socket = io()

        const username = localStorage.getItem('username')

        if (!username && !localStorage.getItem('password')) {
            window.location.href = '/login'
        } else if (username && localStorage.getItem('password')) {
            fetch(`/checkUser?username=${username}&password=${localStorage.getItem('password')}`)
                .then(response => response.json())
                .then(data => {
                    if (data.message !== 'userExists') {
                        localStorage.removeItem('username')
                        localStorage.removeItem('password')
                        localStorage.removeItem('id')
                        window.location.href = '/login'
                    }
                })
        }

        if (localStorage.getItem('winner') && localStorage.getItem('recompensaWinner') && localStorage.getItem('winner') === localStorage.getItem('username')) {
            const gameOver = document.getElementsByClassName('game-over')[0]
            gameOver.style.display = 'flex'
            console.log('Has ganado la partida')
            const winner = document.getElementById('winner')
            winner.textContent = 'You win'
            winner.classList.add('winner')
            const recompensaText = document.getElementsByClassName('recompensa-text')[0]
            console.log(localStorage.getItem('recompensaWinner'))
            recompensaText.textContent = 'Reward: ' + localStorage.getItem('recompensaWinner')
        } else if (localStorage.getItem('loser') && localStorage.getItem('recompensaLoser') && localStorage.getItem('loser') === localStorage.getItem('username')) {
            const gameOver = document.getElementsByClassName('game-over')[0]
            gameOver.style.display = 'flex'
            console.log('Has perdido la partida')
            const winner = document.getElementById('winner')
            winner.textContent = 'You lose'
            winner.classList.add('loser')
            const recompensaText = document.getElementsByClassName('recompensa-text')[0]
            console.log(localStorage.getItem('recompensaLoser'))
            recompensaText.textContent = 'Reward: ' + localStorage.getItem('recompensaLoser')
        }

        let cardClicked = [] /* Para saber con que carta atacas */

        let playedCard = [] /* Para no poner varias veces la misma carta */
        
        let playedCardAttack = [] /* Para no poder atacar si has puesto una carta en el tablero */
        if (localStorage.getItem('playedCardAttack')) {
            playedCardAttack.push(parseInt(localStorage.getItem('playedCardAttack')))
        }

        let specialAttackCard = [] /* Para saber con que carta usas el ataque especial */
        
        window.onload = () => {
            fetch(`getCardsBattle?id=${localStorage.getItem('id')}`)
                .then(response => response.json())
                .then(data => {
                    /* BOARD */
                    // Aqui van las cartas en el tablero del oponente 
                    const opponentBoard = document.getElementsByClassName('opponent-board')[0]
                    if (data.cartasCombates.cartasOpponent) {
                        const cartasOpponent = data.cartasCombates.cartasOpponent
                        cartasOpponent.forEach(card => {
                            if (card.cartaCombate.vida > 0) {
                                const cardDiv = document.createElement('div')
                                cardDiv.className = 'card card-opponent'
                                cardDiv.style.backgroundImage = `url(${card.cartaEnCombateOpponent.foto})`
                                cardDiv.style.backgroundSize = 'contain'
                                cardDiv.style.backgroundRepeat = 'no-repeat'
                                cardDiv.style.backgroundPosition = 'center'
                                cardDiv.id = card.cartaEnCombateOpponent.id
                                cardDiv.addEventListener('click', () => {
                                    if (specialAttackCard.length === 1) {
                                        const tipo = specialAttackCard[0].tipo.split('/')
                                        if (tipo[1] !== 'aliado') { 
                                            socket.emit('special-attack-opponent', { idCartaAttacked: card.cartaEnCombateOpponent.id, idCartaAttacking: specialAttackCard[0].id, idAtaque: specialAttackCard[0].idAtaque, username: localStorage.getItem('username'), tipo: specialAttackCard[0].tipo })
                                            const opponentCards = document.getElementsByClassName('card-opponent')
                                            for (let i = 0; i < opponentCards.length; i++) {
                                                opponentCards[i].style.boxShadow = 'none'
                                                opponentCards[i].style.cursor = 'default'
                                            }
                                        }
                                    } else {
                                        console.log('Card Clicked', cardClicked)
                                        if (cardClicked.length === 1) {
                                            socket.emit('attack', { cardAttacking: cardClicked[0], cardAttacked: card.cartaEnCombateOpponent.id, username: localStorage.getItem('username') })
                                            const opponentCards = document.getElementsByClassName('card-opponent')
                                            for (let i = 0; i < opponentCards.length; i++) {
                                                opponentCards[i].style.boxShadow = 'none'
                                                opponentCards[i].style.cursor = 'default'
                                            }
                                        }
                                    }
                                })

                                const cardName = document.createElement('p')
                                cardName.textContent = card.cartaEnCombateOpponent.nombre
                                cardName.className = 'cardName'

                                const ataqueVida = document.createElement('p')
                                ataqueVida.textContent = card.cartaCombate.ataque + '/' + card.cartaCombate.vida
                                ataqueVida.className = 'ataque-vida ataque-vida-opponent'

                                if (card.ataque) {
                                    const ataqueEspecial = document.createElement('p')
                                    ataqueEspecial.textContent = card.ataque.nombre + ' - ' + card.ataque.descripcion
                                    ataqueEspecial.className = 'ataque-especial ataque-especial-opponent'

                                    cardDiv.appendChild(ataqueEspecial)
                                }

                                cardDiv.appendChild(cardName)
                                cardDiv.appendChild(ataqueVida)
                                opponentBoard.appendChild(cardDiv)
                            }
                        })
                    }

                    // Aqui van las cartas en el tablero del usuario
                    const userBoard = document.getElementsByClassName('user-board')[0]
                    if (data.cartasCombates.cartasUser) {
                        const cartasUser = data.cartasCombates.cartasUser
                        const userDeckId = data.userDeckCards.map(card => card.carta.id)
                        cartasUser.forEach(card => {
                            if (card.cartaCombate.vida > 0) {
                                const cardDiv = document.createElement('div')
                                if (userDeckId.includes(card.cartaEnCombateUser.id)) {
                                    data.userDeckCards.splice(userDeckId.indexOf(card.cartaEnCombateUser.id), 1)
                                    userDeckId.splice(userDeckId.indexOf(card.cartaEnCombateUser.id), 1)
                                }
                                cardDiv.className = 'card card-user'
                                cardDiv.style.backgroundImage = `url(${card.cartaEnCombateUser.foto})`
                                cardDiv.style.backgroundSize = 'contain'
                                cardDiv.style.backgroundRepeat = 'no-repeat'
                                cardDiv.style.backgroundPosition = 'center'
                                cardDiv.id = card.cartaEnCombateUser.id
                                cardDiv.addEventListener('mouseover', () => {
                                    const informacionDiv = document.getElementsByClassName('informacion')[0]
                                    informacionDiv.style.display = 'flex'

                                    if (document.getElementsByClassName('name')[0]) {
                                        const name = document.getElementsByClassName('name')[0]
                                        name.remove()
                                    }

                                    const nombreCarta = document.createElement('p')
                                    nombreCarta.textContent = card.cartaEnCombateUser.nombre
                                    nombreCarta.className = 'name'

                                    informacionDiv.appendChild(nombreCarta)

                                    if (card.ataque) {
                                        if (document.getElementsByClassName('ataque-especial-info')[0]) {
                                            const ataqueEspecialInfo = document.getElementsByClassName('ataque-especial-info')[0]
                                            ataqueEspecialInfo.remove()
                                        }
                                        const ataqueEspecialInfo = document.createElement('p')
                                        ataqueEspecialInfo.textContent = card.ataque.nombre + ' - ' + card.ataque.descripcion
                                        ataqueEspecialInfo.className = 'ataque-especial-info'

                                        informacionDiv.appendChild(ataqueEspecialInfo)
                                    }

                                    if (document.getElementsByClassName('ataque-vida-info')[0]) {
                                        const ataqueVidaInfo = document.getElementsByClassName('ataque-vida-info')[0]
                                        ataqueVidaInfo.remove()
                                    }

                                    const ataqueVidaInfo = document.createElement('p')
                                    ataqueVidaInfo.textContent = card.cartaCombate.ataque + '/' + card.cartaCombate.vida
                                    ataqueVidaInfo.className = 'ataque-vida-info'
                                    
                                    informacionDiv.appendChild(ataqueVidaInfo)
                                })

                                cardDiv.addEventListener('mouseout', () => {
                                    const informacionDiv = document.getElementsByClassName('informacion')[0]
                                    informacionDiv.style.display = 'none'
                                    const name = document.getElementsByClassName('name')[0]
                                    if (card.ataque) {
                                        const ataqueEspecialInfo = document.getElementsByClassName('ataque-especial-info')[0]
                                        ataqueEspecialInfo.remove()
                                    }
                                    const ataqueVidaInfo = document.getElementsByClassName('ataque-vida-info')[0]
                                    name.remove()
                                    ataqueVidaInfo.remove()
                                })

                                const cardName = document.createElement('p')
                                cardName.textContent = card.cartaEnCombateUser.nombre
                                cardName.className = 'cardName'

                                const ataqueVida = document.createElement('p')
                                ataqueVida.textContent = card.cartaCombate.ataque + '/' + card.cartaCombate.vida
                                ataqueVida.className = 'ataque-vida ataque-vida-user'

                                if (card.ataque) {
                                    const ataqueEspecial = document.createElement('p')
                                    ataqueEspecial.textContent = card.ataque.nombre + ' - ' + card.ataque.descripcion
                                    ataqueEspecial.className = 'ataque-especial ataque-especial-user'

                                    cardDiv.appendChild(ataqueEspecial)

                                    if (data.combate.turno_uuid === data.user.id_uuid && card.cartaCombate.ataque_especial === 0) {
                                        const ataqueEspecialButton = document.createElement('button')
                                        ataqueEspecialButton.className = 'ataque-especial-button'
                                        ataqueEspecialButton.textContent = card.ataque.nombre
                                        ataqueEspecialButton.addEventListener('click', () => {
                                            if (specialAttackCard.length === 1) {
                                                const tipo = specialAttackCard[0].tipo.split('/')
                                                if (tipo[1] === 'aliado' && card.cartaEnCombateUser.id !== specialAttackCard[0].id) {
                                                    const userCards = document.getElementsByClassName('card-user')
                                                    for (let i = 0; i < userCards.length; i++) {
                                                        if (parseInt(userCards[i].id) !== card.cartaCombate.id_carta) {
                                                            userCards[i].style.boxShadow = 'none'
                                                        }
                                                    }
                                                } else {
                                                    specialAttackCard = []
                                                    specialAttackCard.push({
                                                        id: card.cartaCombate.id_carta,
                                                        idAtaque: card.ataque.id,
                                                        tipo: card.ataque.tipo
                                                    })
                                                }
                                            } else {
                                                if (parseInt(cardDiv.id) === card.cartaEnCombateUser.id) {
                                                    if (card.cartaCombate.efecto_secundario === 'inmovil') {
                                                        alert('This card is immobilized')
                                                    } else {
                                                        const tipoSplit = card.ataque.tipo.split('/')
                                                        console.log(tipoSplit)
                                                        if (card.ataque.tipo === 'area' || tipoSplit[1] === 'area') {
                                                            socket.emit('special-attack-area', { idCartaAttacking: card.cartaCombate.id_carta, idAtaque: card.ataque.id, username: localStorage.getItem('username'), tipo: card.ataque.tipo })
                                                        } else if (card.ataque.tipo === 'power-up' || card.ataque.tipo === 'inmune' || card.ataque.tipo === 'reverse' && tipoSplit[1] !== 'aliado') {
                                                            socket.emit('special-attack-self', { idCartaAttacking: card.cartaCombate.id_carta, idAtaque: card.ataque.id, username: localStorage.getItem('username'), tipo: card.ataque.tipo })
                                                        } else {
                                                            specialAttackCard.push({
                                                                id: card.cartaCombate.id_carta,
                                                                idAtaque: card.ataque.id,
                                                                tipo: card.ataque.tipo
                                                            })
                                                            if (tipoSplit[1] && tipoSplit[1] === 'aliado') {
                                                                const userCards = document.getElementsByClassName('card-user')
                                                                for (let i = 0; i < userCards.length; i++) {
                                                                    if (parseInt(userCards[i].id) !== card.cartaCombate.id_carta) {
                                                                        userCards[i].style.boxShadow = '0px 0px 7px 4px green'
                                                                    }
                                                                }
                                                            } else {
                                                                console.log(card.ataque.tipo)
                                                                const opponentCards = document.getElementsByClassName('card-opponent')
                                                                if (card.ataque.tipo === 'unico') {
                                                                    for (let i = 0; i < opponentCards.length; i++) {
                                                                        opponentCards[i].style.boxShadow = '0px 0px 7px 4px #901616'
                                                                        opponentCards[i].style.cursor = 'pointer'
                                                                    }
                                                                } else if (card.ataque.tipo === 'power-down') {
                                                                    for (let i = 0; i < opponentCards.length; i++) {
                                                                        opponentCards[i].style.boxShadow = '0px 0px 7px 4px #F34F4F'
                                                                        opponentCards[i].style.cursor = 'pointer'
                                                                    }
                                                                } else if (card.ataque.tipo === 'corrosivo') {
                                                                    for (let i = 0; i < opponentCards.length; i++) {
                                                                        opponentCards[i].style.boxShadow = '0px 0px 7px 4px #B83BDA'
                                                                        opponentCards[i].style.cursor = 'pointer'
                                                                    }
                                                                } else if (card.ataque.tipo === 'inmovil') {
                                                                    for (let i = 0; i < opponentCards.length; i++) {
                                                                        opponentCards[i].style.boxShadow = '0px 0px 7px 4px #C6C4C7'
                                                                        opponentCards[i].style.cursor = 'pointer'
                                                                    }
                                                                } else if (card.ataque.tipo === 'revive') {
                                                                    console.log('Cartas window', data)
                                                                    const userBoard = document.getElementsByClassName('user-board')[0]
                                                                    data.cartasCombates.cartasUser.forEach((cardRevive, index) => {
                                                                        if (cardRevive.cartaCombate.vida <= 0) {
                                                                            //// HAY QUE HACER EL BOTON PARA REVIVIR ////
                                                                            const cardDiv = document.createElement('div')
                                                                            cardDiv.className = 'card card-user card-user-revive'
                                                                            cardDiv.style.backgroundImage = `url(${cardRevive.cartaEnCombateUser.foto})`
                                                                            cardDiv.style.backgroundSize = 'contain'
                                                                            cardDiv.style.backgroundRepeat = 'no-repeat'
                                                                            cardDiv.style.backgroundPosition = 'center'
                                                                            cardDiv.id = cardRevive.cartaEnCombateUser.id
                                                                            cardDiv.style.boxShadow = '0px 0px 7px 4px #181818'
                                                                            cardDiv.addEventListener('mouseover', () => {
                                                                                const informacionDiv = document.getElementsByClassName('informacion')[0]
                                                                                informacionDiv.style.display = 'flex'

                                                                                if (document.getElementsByClassName('name')[0]) {
                                                                                    const name = document.getElementsByClassName('name')[0]
                                                                                    name.remove()
                                                                                }

                                                                                const nombreCarta = document.createElement('p')
                                                                                nombreCarta.textContent = cardRevive.cartaEnCombateUser.nombre
                                                                                nombreCarta.className = 'name'

                                                                                informacionDiv.appendChild(nombreCarta)

                                                                                if (cardRevive.ataque) {
                                                                                    if (document.getElementsByClassName('ataque-especial-info')[0]) {
                                                                                        const ataqueEspecialInfo = document.getElementsByClassName('ataque-especial-info')[0]
                                                                                        ataqueEspecialInfo.remove()
                                                                                    }

                                                                                    const ataqueEspecialInfo = document.createElement('p')
                                                                                    ataqueEspecialInfo.textContent = cardRevive.ataque.nombre + ' - ' + cardRevive.ataque.descripcion
                                                                                    ataqueEspecialInfo.className = 'ataque-especial-info'

                                                                                    informacionDiv.appendChild(ataqueEspecialInfo)
                                                                                }

                                                                                if (document.getElementsByClassName('ataque-vida-info')[0]) {
                                                                                    const ataqueVidaInfo = document.getElementsByClassName('ataque-vida-info')[0]
                                                                                    ataqueVidaInfo.remove()
                                                                                }

                                                                                const ataqueVidaInfo = document.createElement('p')
                                                                                ataqueVidaInfo.textContent = cardRevive.cartaCombate.ataque + '/' + cardRevive.cartaCombate.vida
                                                                                ataqueVidaInfo.className = 'ataque-vida-info'

                                                                                informacionDiv.appendChild(ataqueVidaInfo)
                                                                            })

                                                                            cardDiv.addEventListener('mouseout', () => {
                                                                                const informacionDiv = document.getElementsByClassName('informacion')[0]
                                                                                informacionDiv.style.display = 'none'
                                                                                const name = document.getElementsByClassName('name')[0]
                                                                                if (cardRevive.ataque) {
                                                                                    const ataqueEspecialInfo = document.getElementsByClassName('ataque-especial-info')[0]
                                                                                    ataqueEspecialInfo.remove()
                                                                                }
                                                                                const ataqueVidaInfo = document.getElementsByClassName('ataque-vida-info')[0]
                                                                                name.remove()
                                                                                ataqueVidaInfo.remove()
                                                                            })

                                                                            cardDiv.addEventListener('click', () => {
                                                                                if (specialAttackCard.length === 1 && specialAttackCard[0].tipo === 'revive') {
                                                                                    socket.emit('special-attack-revive', { idCartaAttacked: cardRevive.cartaEnCombateUser.id, idCartaAttacking: specialAttackCard[0].id, idAtaque: specialAttackCard[0].idAtaque, username: localStorage.getItem('username'), tipo: specialAttackCard[0].tipo })
                                                                                    const userCards = document.getElementsByClassName('card-user')
                                                                                    for (let i = 0; i < userCards.length; i++) {
                                                                                        userCards[i].style.boxShadow = 'none'
                                                                                    }
                                                                                }
                                                                            })

                                                                            const cardName = document.createElement('p')
                                                                            cardName.textContent = cardRevive.cartaEnCombateUser.nombre
                                                                            cardName.className = 'cardName'

                                                                            const ataqueVida = document.createElement('p')
                                                                            ataqueVida.textContent = cardRevive.cartaCombate.ataque + '/' + cardRevive.cartaCombate.vida
                                                                            ataqueVida.className = 'ataque-vida ataque-vida-user'

                                                                            if (cardRevive.ataque) {
                                                                                const ataqueEspecial = document.createElement('p')
                                                                                ataqueEspecial.textContent = cardRevive.ataque.nombre + ' - ' + cardRevive.ataque.descripcion
                                                                                ataqueEspecial.className = 'ataque-especial ataque-especial-user'

                                                                                cardDiv.appendChild(ataqueEspecial)
                                                                            }

                                                                            cardDiv.appendChild(cardName)
                                                                            cardDiv.appendChild(ataqueVida)
                                                                            userBoard.appendChild(cardDiv)
                                                                        }
                                                                    })
                                                                }
                                                            }
                                                        }
                                                    }
                                                }   
                                            }
                                        })
                                        cardDiv.appendChild(ataqueEspecialButton)
                                    }
                                }

                                if (data.combate.turno_uuid === data.user.id_uuid) {
                                    const buttonAtaque = document.createElement('button')
                                    buttonAtaque.className = 'attack'

                                    buttonAtaque.addEventListener('click', () => {
                                        if (specialAttackCard.length === 1) {
                                            const tipo = specialAttackCard[0].tipo.split('/')
                                            if (tipo[1] === 'aliado' && card.cartaEnCombateUser.id !== specialAttackCard[0].id) {
                                                socket.emit('special-attack-ally', { idCartaAttacked: card.cartaEnCombateUser.id, idCartaAttacking: specialAttackCard[0].id, idAtaque: specialAttackCard[0].idAtaque, username: localStorage.getItem('username'), tipo: specialAttackCard[0].tipo })
                                                const userCards = document.getElementsByClassName('card-user')
                                                for (let i = 0; i < userCards.length; i++) {
                                                    userCards[i].style.boxShadow = 'none'
                                                }
                                            } else if (tipo[0] === 'revive') {
                                                if (card.vida <= 0 && card.cartaEnCombateUser.id !== specialAttackCard[0].id) {
                                                    console.log('Vida', card.vida)
                                                    socket.emit('special-attack-revive', { idCartaAttacked: card.cartaEnCombateUser.id, idCartaAttacking: specialAttackCard[0].id, idAtaque: specialAttackCard[0].idAtaque, username: localStorage.getItem('username'), tipo: specialAttackCard[0].tipo })
                                                    specialAttackCard = []
                                                    const userCards = document.getElementsByClassName('card-user')
                                                    for (let i = 0; i < userCards.length; i++) {
                                                        userCards[i].style.boxShadow = 'none'
                                                    }
                                                } else {
                                                    const userCardsRevive = document.getElementsByClassName('card-user-revive')
                                                    console.log('Cartas', userCardsRevive)
                                                    for (let i = userCardsRevive.length - 1; i >= 0; i--) {
                                                        userCardsRevive[i].remove()
                                                    }
                                                    specialAttackCard = []
                                                    cardClicked = []
                                                    cardClicked.push(card.cartaEnCombateUser.id)
                                                    const opponentCards = document.getElementsByClassName('card-opponent')
                                                    for (let i = 0; i < opponentCards.length; i++) {
                                                        opponentCards[i].style.boxShadow = '0px 0px 7px 2px red'
                                                        opponentCards[i].style.cursor = 'pointer'
                                                    }
                                                }
                                            }
                                        } else {
                                            if (parseInt(cardDiv.id) === card.cartaEnCombateUser.id) {
                                                if (card.cartaCombate.efecto_secundario === 'inmovil') {
                                                    alert('This card is immobilized')
                                                } else {
                                                    if (playedCardAttack.length !== 0) {
                                                        alert('Ya has puesto cartas en el tablero, no puedes atacar')
                                                    } else {
                                                        if (cardClicked.length === 1) {
                                                            cardClicked = []
                                                        }
                                                        cardClicked.push(card.cartaEnCombateUser.id)
                                                        const opponentCards = document.getElementsByClassName('card-opponent')
                                                        for (let i = 0; i < opponentCards.length; i++) {
                                                            opponentCards[i].style.boxShadow = '0px 0px 7px 2px red'
                                                            opponentCards[i].style.cursor = 'pointer'
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    })

                                    cardDiv.appendChild(buttonAtaque)
                                }
                                
                                cardDiv.appendChild(cardName)
                                cardDiv.appendChild(ataqueVida)
                                userBoard.appendChild(cardDiv)
                            }
                        })
                    }

                    /*Datos usuarios*/
                    // Oponente
                    const opponent = document.getElementsByClassName('opponent')[0]

                    const opponentProfilePicture = document.createElement('img')
                    opponentProfilePicture.src = data.opponent.foto_perfil
                    opponentProfilePicture.alt = 'Profile Picture', data.opponent.user
                    opponentProfilePicture.classList.add('profile-picture-opponent')

                    const opponentUsername = document.createElement('p')
                    opponentUsername.textContent = data.opponent.user
                    opponentUsername.classList.add('username-opponent')

                    opponent.appendChild(opponentProfilePicture)
                    opponent.appendChild(opponentUsername)

                    // Usuario
                    const user = document.getElementsByClassName('user')[0]

                    const profilePicture = document.createElement('img')
                    profilePicture.src = data.user.foto_perfil
                    profilePicture.alt = 'Profile Picture', data.user.user
                    profilePicture.classList.add('profile-picture')

                    const username = document.createElement('p')
                    username.textContent = data.user.user
                    username.classList.add('username')

                    user.appendChild(profilePicture)
                    user.appendChild(username)

                    // Crear el div mana fuera del div user
                    let manaDiv = null;

                    if (data.user.id_uuid === data.combate.id_user_1_uuid) {
                        manaDiv = document.createElement('div')
                        manaDiv.className = 'mana'

                        const manaImg = document.createElement('img')
                        manaImg.src = '/img/mana.png'
                        manaImg.style.border = 'none'
                        manaImg.style.boxShadow = 'none'

                        const mana = document.createElement('p')
                        mana.textContent = data.combate.mana_user_1
                        mana.id = 'mana-number'
                        console.log('Mana', data.combate.mana_user_1)

                        manaDiv.appendChild(mana)
                        manaDiv.appendChild(manaImg)
                    } else if (data.user.id_uuid === data.combate.id_user_2_uuid) {
                        manaDiv = document.createElement('div')
                        manaDiv.className = 'mana'

                        const manaImg = document.createElement('img')
                        manaImg.src = '/img/mana.png'
                        manaImg.style.border = 'none'

                        const mana = document.createElement('p')
                        mana.textContent = data.combate.mana_user_2
                        mana.id = 'mana-number'
                        console.log('Mana', data.combate.mana_user_2)

                        manaDiv.appendChild(mana)
                        manaDiv.appendChild(manaImg)
                    }

                    // AÃ±adir el manaDiv fuera del user div
                    if (manaDiv) {
                        user.parentNode.insertBefore(manaDiv, user.nextSibling);
                    }


                    // Turno
                    const turno = document.getElementById('turno')
                    if (data.combate.turno_uuid === data.user.id_uuid) {
                        turno.textContent = data.user.user + ' turn'
                    } else if (data.combate.turno_uuid === data.opponent.id_uuid) {
                        turno.textContent = data.opponent.user + ' turn'
                    }

                    const yourCards = document.getElementsByClassName('yourCards')[0]

                    /* Cartas del mazo del usuario */
                    data.userDeckCards.forEach(card => {
                        const cardDiv = document.createElement('div')
                        cardDiv.className = 'card card' + card.carta.id
                        cardDiv.style.backgroundImage = `url(${card.carta.foto})`
                        cardDiv.style.backgroundSize = 'contain'
                        cardDiv.style.backgroundRepeat = 'no-repeat'
                        cardDiv.style.backgroundPosition = 'center'
                        cardDiv.id = card.carta.id
                        cardDiv.addEventListener('click', () => {
                            if (playedCard.length === 0) {
                                const user = localStorage.getItem('username')
                                socket.emit('play-card', { id: card.carta.id, user })
                                playedCard.push(card.carta.id)
                                playedCardAttack.push(card.carta.id)
                                localStorage.setItem('playedCardAttack', playedCardAttack)
                            }
                        })

                        const cardName = document.createElement('p')
                        cardName.textContent = card.carta.nombre
                        cardName.className = 'cardName'

                        const ataqueVida = document.createElement('p')
                        ataqueVida.textContent = card.carta.ataque + '/' + card.carta.vida
                        ataqueVida.className = 'ataque-vida'

                        if (card.ataque) {
                            const ataqueEspecial = document.createElement('p')
                            ataqueEspecial.textContent = card.ataque.nombre + ' - ' + card.ataque.descripcion
                            ataqueEspecial.className = 'ataque-especial'

                            cardDiv.appendChild(ataqueEspecial)
                        }

                        cardDiv.appendChild(cardName)
                        cardDiv.appendChild(ataqueVida)
                        yourCards.appendChild(cardDiv)
                    })

                    if (data.combate.turno_uuid === data.user.id_uuid) {
                        const endTurnForm = document.getElementsByClassName('end-turn')[0]
                        endTurnForm.style.display = 'block'
                    } else {
                        const endTurnForm = document.getElementsByClassName('end-turn')[0]
                        endTurnForm.style.display = 'none'
                    }
                })
        }

        /* Formularios */
        const endTurnForm = document.getElementsByClassName('end-turn')[0]
        endTurnForm.addEventListener('submit', (event) => {
            playedCardAttack = []
            localStorage.setItem('playedCardAttack', playedCardAttack)
            event.preventDefault()
            
            const userCards = document.getElementsByClassName('card-user')
            for (let i = 0; i < userCards.length; i++) {
                userCards[i].style.boxShadow = 'none'
            }

            const opponentCards = document.getElementsByClassName('card-opponent')
            for (let i = 0; i < opponentCards.length; i++) {
                opponentCards[i].style.boxShadow = 'none'
                opponentCards[i].style.cursor = 'default'
            }

            specialAttackCard = []
            socket.emit('end-turn', { username: localStorage.getItem('username') })
        })

        const leaveBattle = document.getElementsByClassName('leave-battle')[0]
        leaveBattle.addEventListener('submit', (event) => {
            event.preventDefault()
            const rewardSplit = document.getElementsByClassName('recompensa-text')[0].textContent.split(' ')
            console.log('Reward', rewardSplit[1])
            socket.emit('leave-battle', { username: localStorage.getItem('username'), reward: parseInt(rewardSplit[1]) })
        })

        const leaveMatchForm = document.getElementsByClassName('leave-match')[0]
        leaveMatchForm.addEventListener('submit', (event) => {
            event.preventDefault()
            socket.emit('leave-match', { username: localStorage.getItem('username') })
        })

        /* Recibir mensajes del servidor */
        socket.on('played-card', (data) => {
            console.log('Carta jugada', data)
            playedCard = []
            const cardDivPlayed = document.createElement('div')
            cardDivPlayed.style.backgroundImage = `url(${data.carta.foto})`
            cardDivPlayed.style.backgroundSize = 'contain'
            cardDivPlayed.style.backgroundRepeat = 'no-repeat'
            cardDivPlayed.style.backgroundPosition = 'center'
            cardDivPlayed.id = data.carta.id
            cardDivPlayed.addEventListener('mouseover', () => {
                const informacionDiv = document.getElementsByClassName('informacion')[0]
                informacionDiv.style.display = 'flex'

                if (document.getElementsByClassName('name')[0]) {
                    const name = document.getElementsByClassName('name')[0]
                    name.remove()
                }

                const nombreCarta = document.createElement('p')
                nombreCarta.textContent = data.carta.nombre
                nombreCarta.className = 'name'

                informacionDiv.appendChild(nombreCarta)

                if (data.ataque) {
                    if (document.getElementsByClassName('ataque-especial-info')[0]) {
                        const ataqueEspecialInfo = document.getElementsByClassName('ataque-especial-info')[0]
                        ataqueEspecialInfo.remove()
                    }
                    const ataqueEspecialInfo = document.createElement('p')
                    ataqueEspecialInfo.textContent = data.ataque.nombre + ' - ' + data.ataque.descripcion
                    ataqueEspecialInfo.className = 'ataque-especial-info'

                    informacionDiv.appendChild(ataqueEspecialInfo)
                }

                if (document.getElementsByClassName('ataque-vida-info')[0]) {
                    const ataqueVidaInfo = document.getElementsByClassName('ataque-vida-info')[0]
                    ataqueVidaInfo.remove()
                }

                const ataqueVidaInfo = document.createElement('p')
                ataqueVidaInfo.textContent = data.carta.ataque + '/' + data.carta.vida
                ataqueVidaInfo.className = 'ataque-vida-info'

                informacionDiv.appendChild(ataqueVidaInfo)
            })

            cardDivPlayed.addEventListener('mouseout', () => {
                const informacionDiv = document.getElementsByClassName('informacion')[0]
                informacionDiv.style.display = 'none'
                const name = document.getElementsByClassName('name')[0]
                if (data.ataque) {
                    const ataqueEspecialInfo = document.getElementsByClassName('ataque-especial-info')[0]
                    ataqueEspecialInfo.remove()
                }
                const ataqueVidaInfo = document.getElementsByClassName('ataque-vida-info')[0]
                name.remove()
                ataqueVidaInfo.remove()
            })

            if (data.user === localStorage.getItem('username')) {
                cardDivPlayed.className = 'card card-user'
            } else if (data.user === localStorage.getItem('opponent')) {
                cardDivPlayed.className = 'card card-opponent'
            }

            const cardNamePlayed = document.createElement('p')
            cardNamePlayed.textContent = data.carta.nombre
            cardNamePlayed.className = 'cardName'

            if (data.ataque) {
                const ataqueEspecialPlayed = document.createElement('p')
                ataqueEspecialPlayed.textContent = data.ataque.nombre + ' - ' + data.ataque.descripcion
                ataqueEspecialPlayed.className = 'ataque-especial'

                cardDivPlayed.appendChild(ataqueEspecialPlayed)

                /* AQUI SE PODRIA PONER EL BOTON DE ATAQUE ESPECIAL */
            }

            cardDivPlayed.appendChild(cardNamePlayed)

            if (data.user === localStorage.getItem('username')) {
                const ataqueVidaPlayed = document.createElement('p')
                ataqueVidaPlayed.textContent = data.carta.ataque + '/' + data.carta.vida
                ataqueVidaPlayed.className = 'ataque-vida ataque-vida-user'
                cardDivPlayed.appendChild(ataqueVidaPlayed)

                const buttonAtaque = document.createElement('button')
                buttonAtaque.className = 'attack'
                buttonAtaque.addEventListener('click', () => {
                    if (specialAttackCard.length === 1) {
                        const tipo = specialAttackCard[0].tipo.split('/')
                        if (tipo[1] === 'aliado' && data.carta.id !== specialAttackCard[0].id) {
                            const userCards = document.getElementsByClassName('card-user')
                            for (let i = 0; i < userCards.length; i++) {
                                if (parseInt(userCards[i].id) !== data.carta.id) {
                                    userCards[i].style.boxShadow = 'none'
                                }
                            }
                        } else {
                            specialAttackCard = []
                            specialAttackCard.push({
                                id: data.carta.id,
                                idAtaque: data.ataque.id,
                                tipo: data.ataque.tipo
                            })
                        }
                    } else {
                        if (data.tipo === 'inmovil' || data.carta.efecto_secundario === 'inmovil') {
                            alert('This card is immobilized')
                        } else {
                            if (playedCardAttack.length !== 0) {
                                alert('Ya has puesto cartas en el tablero, no puedes atacar')
                            } else {
                                if (cardClicked.length === 1) {
                                    cardClicked = []
                                }
                                cardClicked.push(data.carta.id)
                                const opponentCards = document.getElementsByClassName('card-opponent')
                                for (let i = 0; i < opponentCards.length; i++) {
                                    opponentCards[i].style.boxShadow = '0px 0px 7px 2px red'
                                    opponentCards[i].style.cursor = 'pointer'
                                }
                            }
                        
                        }
                    }
                })

                cardDivPlayed.appendChild(buttonAtaque)

                const userBoard = document.getElementsByClassName('user-board')[0]
                userBoard.appendChild(cardDivPlayed)

                document.getElementsByClassName('card' + data.carta.id)[0].remove()

                const manaNumber = document.getElementById('mana-number')
                manaNumber.textContent = data.mana
            } else if (data.user === localStorage.getItem('opponent')) {
                const ataqueVidaPlayed = document.createElement('p')
                ataqueVidaPlayed.textContent = data.carta.ataque + '/' + data.carta.vida
                ataqueVidaPlayed.className = 'ataque-vida ataque-vida-opponent'
                cardDivPlayed.appendChild(ataqueVidaPlayed)

                cardDivPlayed.addEventListener('click', () => {
                    if (specialAttackCard.length === 1) {
                        const tipo = specialAttackCard[0].tipo.split('/')
                        if (tipo[1] !== 'aliado') {
                            socket.emit('special-attack-opponent', { idCartaAttacked: data.carta.id, idCartaAttacking: specialAttackCard[0].id, idAtaque: specialAttackCard[0].idAtaque, username: localStorage.getItem('username'), tipo: specialAttackCard[0].tipo })
                            const opponentCards = document.getElementsByClassName('card-opponent')
                            for (let i = 0; i < opponentCards.length; i++) {
                                opponentCards[i].style.boxShadow = 'none'
                                opponentCards[i].style.cursor = 'default'
                            }
                        }
                    } else {
                        if (cardClicked.length === 1) {
                            socket.emit('attack', { cardAttacking: cardClicked[0], cardAttacked: data.carta.id, username: localStorage.getItem('username') })
                            const opponentCards = document.getElementsByClassName('card-opponent')
                            for (let i = 0; i < opponentCards.length; i++) {
                                opponentCards[i].style.boxShadow = 'none'
                                opponentCards[i].style.cursor = 'default'
                            }
                        }
                    }
                })
                const opponentBoard = document.getElementsByClassName('opponent-board')[0]
                opponentBoard.appendChild(cardDivPlayed)
            }
        })

        socket.on('not-enough-mana', (data) => {
            if (data.username === localStorage.getItem('username')) {
                alert('No tienes suficiente mana para jugar esa carta')
                playedCard = []
                cardClicked = []
                specialAttackCard = []
                if (document.getElementsByClassName('card-user-revive')) {
                    const userCardsRevive = document.getElementsByClassName('card-user-revive')
                    for (let i = userCardsRevive.length - 1; i >= 0; i--) {
                        userCardsRevive[i].remove()
                    }
                }
                /* Fem que si no tenim mana per jugar la carta, aquesta faci una animaciÃ³ */
                if (data.idCarta && document.getElementsByClassName('card' + data.idCarta)[0]) {
                    const card = document.getElementsByClassName('card' + data.idCarta)[0]
                    card.classList.remove('card-no-mana')

                    setTimeout(() => {
                        card.classList.add('card-no-mana')
                    }, 10) 

                    setTimeout(() => {
                        card.classList.remove('card-no-mana')
                    }, 600) 
                }
            }
        })

        socket.on('not-your-turn', (data) => {
            if (data.username === localStorage.getItem('username')) {
                alert('No es tu turno')
                playedCard = []
            }
        })

        socket.on('attacked', (data) => {
            if (data.opponent === localStorage.getItem('opponent')) {
                const cardUser = document.getElementsByClassName('card-user')
                for (let i = 0; i < cardUser.length; i++) {
                    if (parseInt(cardUser[i].id) === data.cardAttacking.id_carta) {
                        cardUser[i].classList.remove('card-atacando')

                        setTimeout(() => {
                            cardUser[i].classList.add('card-atacando')
                        }, 10)

                        setTimeout(() => {
                            cardUser[i].classList.remove('card-atacando')
                        }, 600)
                    }
                }

                const cardOpponent = document.getElementsByClassName('card-opponent')
                for (let i = cardOpponent.length - 1; i >= 0; i--) {
                    if (parseInt(cardOpponent[i].id) === data.cardAttacked.id_carta) {
                        if (data.vida <= 0) {
                            cardOpponent[i].classList.remove('card-muere')

                            setTimeout(() => {
                                cardOpponent[i].classList.add('card-muere')
                            }, 10)

                            setTimeout(() => {
                                cardOpponent[i].classList.remove('card-muere')
                            }, 900)
                            cardOpponent[i].remove()
                        } else {
                            cardOpponent[i].classList.remove('card-atacado')

                            setTimeout(() => {
                                cardOpponent[i].classList.add('card-atacado')
                            }, 10)

                            setTimeout(() => {
                                cardOpponent[i].classList.remove('card-atacado')
                            }, 600)
                            const ataqueVida = document.getElementsByClassName('ataque-vida-opponent')[i]
                            let ataqueVidaText = ataqueVida.textContent.split('/')
                            ataqueVidaText = ataqueVidaText[0] + '/' + data.vida
                            ataqueVida.textContent = ataqueVidaText
                        }
                    }
                    if (cardOpponent[i]) {
                        cardOpponent[i].style.boxShadow = 'none'
                        cardOpponent[i].style.cursor = 'default'
                    }
                }
            } else if (data.opponent === localStorage.getItem('username')) {
                const cardOpponent = document.getElementsByClassName('card-opponent')
                for (let i = 0; i < cardOpponent.length; i++) {
                    if (parseInt(cardOpponent[i].id) === data.cardAttacking.id_carta) {
                        cardOpponent[i].classList.remove('card-atacando-oponente')

                        setTimeout(() => {
                            cardOpponent[i].classList.add('card-atacando-oponente')
                        }, 10)

                        setTimeout(() => {
                            cardOpponent[i].classList.remove('card-atacando-oponente')
                        }, 600)
                    }
                }

                const cardUser = document.getElementsByClassName('card-user')
                for (let i = cardUser.length - 1; i >= 0; i--) {
                    if (parseInt(cardUser[i].id) === data.cardAttacked.id_carta) {
                        cardUser[i].classList.remove('card-atacado')

                        setTimeout(() => {
                            cardUser[i].classList.add('card-atacado')
                        }, 10)

                        setTimeout(() => {
                            cardUser[i].classList.remove('card-atacado')
                        }, 600)
                    }
                    if (cardUser[i]) {
                        cardUser[i].style.boxShadow = 'none'
                    }
                }               
                console.log('Mana :)', data.mana)
                const manaNumber = document.getElementById('mana-number')
                manaNumber.textContent = data.mana
            }
        })

        socket.on('immune-card', (data) => {
            if (data.username === localStorage.getItem('username')) {
                alert('This card is immune')
            }
        })

        socket.on('special-attacked-ally', (data) => {
            if (data.username === localStorage.getItem('opponent')) {
                const opponentCards = document.getElementsByClassName('card-opponent')
                for (let i = 0; i < opponentCards.length; i++) {
                    data.opponentCards.forEach(card => {
                        if (parseInt(opponentCards[i].id) === card.id_carta) {
                            if (card.vida <= 0) {
                                opponentCards[i].classList.remove('card-muere')

                                setTimeout(() => {
                                    opponentCards[i].classList.add('card-muere')
                                }, 10)

                                setTimeout(() => {
                                    opponentCards[i].remove()
                                }, 600)

                                opponentCards[i].remove()
                                const manaNumber = document.getElementById('mana-number')
                                manaNumber.textContent = data.mana
                            } else {
                                const ataqueVida = document.getElementsByClassName('ataque-vida-opponent')[i]
                                const ataqueVidaText = card.ataque + '/' + card.vida
                                ataqueVida.textContent = ataqueVidaText
                            }
                        }
                    })
                    opponentCards[i].style.boxShadow = 'none'
                    opponentCards[i].style.cursor = 'default'
                }
            }

            if (data.username === localStorage.getItem('username')) {
                const userCards = document.getElementsByClassName('card-user')
                for (let i = 0; i < userCards.length; i++) {
                    data.opponentCards.forEach((card, index) => {
                        if (parseInt(userCards[i].id) === card.id_carta) {
                            if (card.vida <= 0) {
                                userCards[i].classList.remove('card-muere')

                                setTimeout(() => {
                                    userCards[i].classList.add('card-muere')
                                }, 10)

                                setTimeout(() => {
                                    userCards[i].remove()
                                }, 600)

                                userCards[i].remove()
                                const manaNumber = document.getElementById('mana-number')
                                manaNumber.textContent = data.mana
                            } else {
                                const ataqueVida = document.getElementsByClassName('ataque-vida-user')[i]
                                const ataqueVidaText = card.ataque + '/' + card.vida
                                ataqueVida.textContent = ataqueVidaText
                                ////////////////// AQUI LO QUE HACE LA CARTA AL SER ATACADA //////////////////
                            }
                        }
                    })
                    userCards[i].style.boxShadow = 'none'
                }
            }
        })

        socket.on('special-attacked-self', (data) => {
            if (data.opponent === localStorage.getItem('opponent')) {
                const opponentCards = document.getElementsByClassName('card-opponent')
                for (let i = 0; i < opponentCards.length; i++) {
                    data.opponentCards.forEach(card => {
                        if (parseInt(opponentCards[i].id) === card.id_carta) {
                            if (card.vida <= 0) {
                                opponentCards[i].remove()
                                const manaNumber = document.getElementById('mana-number')
                                manaNumber.textContent = data.mana
                            } else {
                                if (card.id_carta === data.idCarta && data.estadistica === 'vida') {
                                    opponentCards[i].classList.remove('card-heal')

                                    setTimeout(() => {
                                        opponentCards[i].classList.add('card-heal')
                                    }, 10)

                                    setTimeout(() => {
                                        opponentCards[i].classList.remove('card-heal')
                                    }, 600)
                                }
                                const ataqueVida = document.getElementsByClassName('ataque-vida-opponent')[i]
                                const ataqueVidaText = card.ataque + '/' + card.vida
                                ataqueVida.textContent = ataqueVidaText
                                ////////////////// AQUI LO QUE HACE LA CARTA AL SER ATACADA //////////////////
                            }
                        }
                    })
                    opponentCards[i].style.boxShadow = 'none'
                    opponentCards[i].style.cursor = 'default'
                }
            } else if (data.opponent === localStorage.getItem('username')) {
                const userCards = document.getElementsByClassName('card-user')
                for (let i = 0; i < userCards.length; i++) {
                    data.opponentCards.forEach((card, index) => {
                        if (parseInt(userCards[i].id) === card.id_carta) {
                            if (card.vida <= 0) {
                                userCards[i].remove()
                                const manaNumber = document.getElementById('mana-number')
                                manaNumber.textContent = data.mana
                            } else {
                                if (card.id_carta === data.idCarta && data.estadistica === 'vida') {
                                    userCards[i].classList.remove('card-heal')

                                    setTimeout(() => {
                                        userCards[i].classList.add('card-heal')
                                    }, 10)

                                    setTimeout(() => {
                                        userCards[i].classList.remove('card-heal')
                                    }, 600)
                                }
                                const ataqueVida = document.getElementsByClassName('ataque-vida-user')[i]
                                const ataqueVidaText = card.ataque + '/' + card.vida
                                ataqueVida.textContent = ataqueVidaText
                                ////////////////// AQUI LO QUE HACE LA CARTA AL SER ATACADA //////////////////
                            }
                        }
                    })
                    userCards[i].style.boxShadow = 'none'
                }
            }
        })

        socket.on('special-attacked-revive', (data) => {
            if (data.username === localStorage.getItem('opponent')) {
                const opponentCards = document.getElementsByClassName('card-opponent')
                const opponentBoard = document.getElementsByClassName('opponent-board')[0]
                for (let i = opponentCards.length - 1; i >= 0; i--) {
                    opponentCards[i].remove()
                }
                data.cartasUser.cartasInfo.forEach((card, index) => {
                    if (data.cartasUser.cartasCombate[index].vida > 0) {
                        const cardDiv = document.createElement('div')
                        cardDiv.className = 'card card-opponent'
                        cardDiv.style.backgroundImage = `url(${card.foto})`
                        cardDiv.style.backgroundSize = 'contain'
                        cardDiv.style.backgroundRepeat = 'no-repeat'
                        cardDiv.style.backgroundPosition = 'center'
                        cardDiv.id = data.cartasUser.cartasCombate[index].id_carta

                        cardDiv.addEventListener('click', () => {
                            if (specialAttackCard.length === 1) {
                                const tipo = specialAttackCard[0].tipo.split('/')
                                if (tipo[1] !== 'aliado') {
                                    socket.emit('special-attack-opponent', { idCartaAttacked: data.cartasUser.cartasCombate[index].id_carta, idCartaAttacking: specialAttackCard[0].id, idAtaque: specialAttackCard[0].idAtaque, username: localStorage.getItem('username'), tipo: specialAttackCard[0].tipo })
                                    const opponentCards = document.getElementsByClassName('card-opponent')
                                    for (let i = 0; i < opponentCards.length; i++) {
                                        opponentCards[i].style.boxShadow = 'none'
                                        opponentCards[i].style.cursor = 'default'
                                    }
                                }
                            } else {
                                if (cardClicked.length === 1) {
                                    socket.emit('attack', { cardAttacking: cardClicked[0], cardAttacked: data.cartasUser.cartasCombate[index].id_carta, username: localStorage.getItem('username') })
                                    const opponentCards = document.getElementsByClassName('card-opponent')
                                    for (let i = 0; i < opponentCards.length; i++) {
                                        opponentCards[i].style.boxShadow = 'none'
                                        opponentCards[i].style.cursor = 'default'
                                    }
                                }
                            }
                        })

                        const cardName = document.createElement('p')
                        cardName.textContent = data.cartasUser.cartasInfo[index].nombre
                        cardName.className = 'cardName'

                        const ataqueVida = document.createElement('p')
                        ataqueVida.textContent = data.cartasUser.cartasCombate[index].ataque + '/' + data.cartasUser.cartasCombate[index].vida
                        ataqueVida.className = 'ataque-vida ataque-vida-opponent'

                        if (data.cartasUser.cartasCombate[index].ataque_especial) {
                            const ataqueEspecial = document.createElement('p')
                            ataqueEspecial.textContent = data.cartasUser.ataques[index].nombre + ' - ' + data.cartasUser.ataques[index].descripcion
                            ataqueEspecial.className = 'ataque-especial ataque-especial-opponent'

                            cardDiv.appendChild(ataqueEspecial)
                        }

                        cardDiv.appendChild(cardName)
                        cardDiv.appendChild(ataqueVida)
                        opponentBoard.appendChild(cardDiv)
                    }
                })
            } else if (data.username === localStorage.getItem('username')) {
                console.log('Data', data)
                console.log('Cartas', data.cartasUser)
                const userCards = document.getElementsByClassName('card-user')
                const manaNumber = document.getElementById('mana-number')
                manaNumber.textContent = data.mana
                const length = userCards.length - 1
                for (let i = length; i >= 0; i--) {
                    userCards[i].remove()
                }
                const userBoard = document.getElementsByClassName('user-board')[0]
                data.cartasUser.cartasInfo.forEach((card, index) => {
                    console.log(card)
                    if (data.cartasUser.cartasCombate[index].vida > 0){
                        const cardDiv = document.createElement('div')
                        cardDiv.className = 'card card-user'
                        cardDiv.style.backgroundImage = `url(${card.foto})`
                        cardDiv.style.backgroundSize = 'contain'
                        cardDiv.style.backgroundRepeat = 'no-repeat'
                        cardDiv.style.backgroundPosition = 'center'
                        cardDiv.id = data.cartasUser.cartasCombate[index].id_carta
                        cardDiv.addEventListener('mouseover', () => {
                            const informacionDiv = document.getElementsByClassName('informacion')[0]
                            informacionDiv.style.display = 'flex'

                            if (document.getElementsByClassName('name')[0]) {
                                const name = document.getElementsByClassName('name')[0]
                                name.remove()
                            }

                            const nombreCarta = document.createElement('p')
                            nombreCarta.textContent = data.cartasUser.cartasInfo[index].nombre
                            nombreCarta.className = 'name'

                            informacionDiv.appendChild(nombreCarta)

                            if (data.cartasUser.ataques[index]) {
                                if (document.getElementsByClassName('ataque-especial-info')[0]) {
                                    const ataqueEspecialInfo = document.getElementsByClassName('ataque-especial-info')[0]
                                    ataqueEspecialInfo.remove()
                                }
                                const ataqueEspecialInfo = document.createElement('p')
                                ataqueEspecialInfo.textContent = data.cartasUser.ataques[index].nombre + ' - ' + data.cartasUser.ataques[index].descripcion
                                ataqueEspecialInfo.className = 'ataque-especial-info'

                                informacionDiv.appendChild(ataqueEspecialInfo)
                            }

                            if (document.getElementsByClassName('ataque-vida-info')[0]) {
                                const ataqueVidaInfo = document.getElementsByClassName('ataque-vida-info')[0]
                                ataqueVidaInfo.remove()
                            }

                            const ataqueVidaInfo = document.createElement('p')
                            ataqueVidaInfo.textContent = data.cartasUser.cartasCombate[index].ataque + '/' + data.cartasUser.cartasCombate[index].vida
                            ataqueVidaInfo.className = 'ataque-vida-info'

                            informacionDiv.appendChild(ataqueVidaInfo)
                        })

                        cardDiv.addEventListener('mouseout', () => {
                            const informacionDiv = document.getElementsByClassName('informacion')[0]
                            informacionDiv.style.display = 'none'
                            const name = document.getElementsByClassName('name')[0]
                            if (data.cartasUser.ataques[index]) {
                                const ataqueEspecialInfo = document.getElementsByClassName('ataque-especial-info')[0]
                                ataqueEspecialInfo.remove()
                            }
                            const ataqueVidaInfo = document.getElementsByClassName('ataque-vida-info')[0]
                            name.remove()
                            ataqueVidaInfo.remove()
                        })

                        cardDiv.addEventListener('click', () => {
                            if (specialAttackCard.length === 1) {
                                const tipo = specialAttackCard[0].tipo.split('/')
                                if (tipo[1] === 'aliado' && card.id_carta !== specialAttackCard[0].id) {
                                    socket.emit('special-attack-ally', { idCartaAttacked: card.id_carta, idCartaAttacking: specialAttackCard[0].id, idAtaque: specialAttackCard[0].idAtaque, username: localStorage.getItem('username'), tipo: specialAttackCard[0].tipo })
                                    const userCards = document.getElementsByClassName('card-user')
                                    for (let i = 0; i < userCards.length; i++) {
                                        userCards[i].style.boxShadow = 'none'
                                    }
                                } else if (tipo[0] === 'revive' && card.id_carta !== specialAttackCard[0].id && card.vida <= 0) {
                                    socket.emit('special-attack-revive', { idCartaAttacked: card.id_carta, idCartaAttacking: specialAttackCard[0].id, idAtaque: specialAttackCard[0].idAtaque, username: localStorage.getItem('username'), tipo: specialAttackCard[0].tipo })
                                    specialAttackCard = []
                                    const userCards = document.getElementsByClassName('card-user')
                                    for (let i = 0; i < userCards.length; i++) {
                                        userCards[i].style.boxShadow = 'none'
                                    }
                                }
                            } else {
                                if (parseInt(userCards[i].id) === card.id_carta) {
                                    if (card.efecto_secundario === 'inmovil') {
                                        alert('This card is immobilized')
                                    } else {
                                        if (playedCardAttack.length !== 0) {
                                            alert('Ya has puesto cartas en el tablero, no puedes atacar')
                                        } else {
                                            if (cardClicked.length === 1) {
                                                cardClicked = []
                                            }
                                            cardClicked.push(card.id_carta)
                                            const opponentCards = document.getElementsByClassName('card-opponent')
                                            for (let i = 0; i < opponentCards.length; i++) {
                                                opponentCards[i].style.boxShadow = '0px 0px 7px 2px red'
                                                opponentCards[i].style.cursor = 'pointer'
                                            }
                                        }
                                    }
                                }
                            }
                        })

                        const cardName = document.createElement('p')
                        cardName.textContent = data.cartasUser.cartasInfo[index].nombre
                        cardName.className = 'cardName'

                        const ataqueVida = document.createElement('p')
                        console.log(data.cartasUser.cartasCombate[index].ataque + '/' + data.cartasUser.cartasCombate[index].vida)
                        ataqueVida.textContent = data.cartasUser.cartasCombate[index].ataque + '/' + data.cartasUser.cartasCombate[index].vida
                        ataqueVida.className = 'ataque-vida ataque-vida-user'

                        if (card.ataque_especial) {
                            const ataqueEspecial = document.createElement('p')
                            console.log(data.cartasUser.ataques[index].nombre + ' - ' + data.cartasUser.ataques[index].descripcion)
                            ataqueEspecial.textContent = data.cartasUser.ataques[index].nombre + ' - ' + data.cartasUser.ataques[index].descripcion
                            ataqueEspecial.className = 'ataque-especial ataque-especial-user'

                            cardDiv.appendChild(ataqueEspecial)
                        }

                        cardDiv.appendChild(cardName)
                        cardDiv.appendChild(ataqueVida)
                        userBoard.appendChild(cardDiv)
                    }
                })
            }
        })

        socket.on('special-attacked-opponent', (data) => {
            if (data.opponent === localStorage.getItem('opponent')) {
                const opponentCards = document.getElementsByClassName('card-opponent')
                for (let i = 0; i < opponentCards.length; i++) {
                    data.opponentCards.forEach(card => {
                        if (parseInt(opponentCards[i].id) === card.id_carta) {
                            if (card.vida <= 0) {
                                opponentCards[i].classList.remove('card-muere')
                                
                                setTimeout(() => {
                                    opponentCards[i].classList.add('card-muere')
                                }, 10)

                                setTimeout(() => {
                                    opponentCards[i].classList.remove('card-muere')
                                }, 900)
                                opponentCards[i].remove()
                            } else {
                                const ataqueVida = document.getElementsByClassName('ataque-vida-opponent')[i]
                                const ataqueVidaText = card.ataque + '/' + card.vida
                                ataqueVida.textContent = ataqueVidaText
                                ////////////////// AQUI LO QUE HACE LA CARTA AL SER ATACADA //////////////////
                            }
                        }
                    })
                    if (opponentCards[i]){
                        opponentCards[i].style.boxShadow = 'none'
                        opponentCards[i].style.cursor = 'default'
                    }
                }
            } else if (data.opponent === localStorage.getItem('username')) {
                const userCards = document.getElementsByClassName('card-user')
                for (let i = 0; i < userCards.length; i++) {
                    data.opponentCards.forEach((card, index) => {
                        if (parseInt(userCards[i].id) === card.id_carta) {
                            if (card.vida <= 0) {
                                userCards[i].classList.remove('card-muere')

                                setTimeout(() => {
                                    userCards[i].classList.add('card-muere')
                                }, 10)

                                setTimeout(() => {
                                    userCards[i].classList.remove('card-muere')
                                }, 900)
                                userCards[i].remove()
                                const manaNumber = document.getElementById('mana-number')
                                manaNumber.textContent = data.mana
                            } else {
                                const ataqueVida = document.getElementsByClassName('ataque-vida-user')[i]
                                const ataqueVidaText = card.ataque + '/' + card.vida
                                ataqueVida.textContent = ataqueVidaText
                                ////////////////// AQUI LO QUE HACE LA CARTA AL SER ATACADA //////////////////
                            }
                        }
                    })
                    if (userCards[i]){
                        userCards[i].style.boxShadow = 'none'
                    }
                }
            }
        })

        socket.on('special-attacked-area', (data) => {
            if (data.opponent === localStorage.getItem('opponent')) {
                const opponentCards = document.getElementsByClassName('card-opponent')
                for (let i = 0; i < opponentCards.length; i++) {
                    data.opponentCards.forEach(card => {
                        if (parseInt(opponentCards[i].id) === card.id_carta) {
                            if (card.vida <= 0) {
                                opponentCards[i].classList.remove('card-muere')

                                setTimeout(() => {
                                    opponentCards[i].classList.add('card-muere')
                                }, 10)

                                setTimeout(() => {
                                    opponentCards[i].remove()
                                }, 600)
                                opponentCards[i].remove()
                                const manaNumber = document.getElementById('mana-number')
                                manaNumber.textContent = data.mana
                            } else {
                                if (data.estadistica === 'vida' && data.tipo === 'power-up') {
                                    opponentCards[i].classList.remove('card-heal')

                                    setTimeout(() => {
                                        opponentCards[i].classList.add('card-heal')
                                    }, 10)

                                    setTimeout(() => {
                                        opponentCards[i].classList.remove('card-heal')
                                    }, 900)
                                }
                                const ataqueVida = document.getElementsByClassName('ataque-vida-opponent')[i]
                                const ataqueVidaText = card.ataque + '/' + card.vida
                                ataqueVida.textContent = ataqueVidaText
                                ////////////////// AQUI LO QUE HACE LA CARTA AL SER ATACADA //////////////////
                            }
                        }
                    })
                    opponentCards[i].style.boxShadow = 'none'
                    opponentCards[i].style.cursor = 'default'
                }
            } else if (data.opponent === localStorage.getItem('username')) {
                const userCards = document.getElementsByClassName('card-user')
                for (let i = 0; i < userCards.length; i++) {
                    data.opponentCards.forEach((card, index) => {
                        if (parseInt(userCards[i].id) === card.id_carta) {
                            if (card.vida <= 0) {
                                userCards[i].classList.remove('card-muere')

                                setTimeout(() => {
                                    userCards[i].classList.add('card-muere')
                                }, 10)

                                setTimeout(() => {
                                    userCards[i].classList.remove('card-muere')
                                }, 900)
                                userCards[i].remove()
                                const manaNumber = document.getElementById('mana-number')
                                manaNumber.textContent = data.mana
                            } else {
                                if (data.estadistica === 'vida' && data.tipo === 'power-up') {
                                    userCards[i].classList.remove('card-heal')

                                    setTimeout(() => {
                                        userCards[i].classList.add('card-heal')
                                    }, 10)

                                    setTimeout(() => {
                                        userCards[i].classList.remove('card-heal')
                                    }, 600)
                                }
                                const ataqueVida = document.getElementsByClassName('ataque-vida-user')[i]
                                const ataqueVidaText = card.ataque + '/' + card.vida
                                ataqueVida.textContent = ataqueVidaText
                                ////////////////// AQUI LO QUE HACE LA CARTA AL SER ATACADA //////////////////
                            }
                        }
                    })
                    userCards[i].style.boxShadow = 'none'
                }
            }
        })

        socket.on('ended-turn', (data) => {
            console.log('Ended Turn', data)
            if (data.username === localStorage.getItem('username')) {
                cardClicked = []     
                specialAttackCard = []
                const userCardsRevive = document.getElementsByClassName('card-user-revive')
                for (let i = userCardsRevive.length - 1; i >= 0; i--) {
                    userCardsRevive[i].remove()
                }
                const turno = document.getElementById('turno')
                turno.textContent = localStorage.getItem('opponent') + ' turn'
                const endTurnForm = document.getElementsByClassName('end-turn')[0]
                endTurnForm.style.display = 'none'

                const ataqueVidaOpponent = document.getElementsByClassName('ataque-vida-opponent')
                const cardOpponent = document.getElementsByClassName('card-opponent')
                for (let i = 0; i < ataqueVidaOpponent.length; i++) {
                    data.cartas.cartasCombate.forEach(card => {
                        if (cardOpponent.length > 0) {
                            if (parseInt(cardOpponent[i].id) === card.id_carta) {
                                if (card.vida <= 0) {
                                    cardOpponent[i].classList.remove('card-muere')

                                    setTimeout(() => {
                                        cardOpponent[i].classList.add('card-muere')
                                    }, 10)

                                    setTimeout(() => {
                                        cardOpponent[i].classList.remove('card-muere')
                                    }, 900)

                                    cardOpponent[i].remove()
                                } else {
                                    ataqueVidaOpponent[i].textContent = card.ataque + '/' + card.vida
                                }
                            }
                        }
                    })
                }

                const attacks = document.querySelectorAll('.attack')

                attacks.forEach(attack => {
                    attack.remove()
                })

                const ataquesEspeciales = document.querySelectorAll('.ataque-especial-button')

                ataquesEspeciales.forEach(ataqueEspecial => {
                    ataqueEspecial.remove()
                })
            } else if (data.username === localStorage.getItem('opponent')) {
                console.log('Opponent', data)
                if (document.querySelectorAll('.attack')) {
                    const attacks = document.querySelectorAll('.attack')
                    attacks.forEach(attack => {
                        attack.remove()
                    })
                } else if (document.querySelectorAll('.ataque-especial-button')) {
                    const ataquesEspeciales = document.querySelectorAll('.ataque-especial-button')
                    ataquesEspeciales.forEach(ataqueEspecial => {
                        ataqueEspecial.remove()
                    })
                }
                cardClicked = []
                specialAttackCard = []
                const turno = document.getElementById('turno')
                turno.textContent = localStorage.getItem('username') + ' turn'
                const endTurnForm = document.getElementsByClassName('end-turn')[0]
                endTurnForm.style.display = 'block'

                const ataqueVidaUser = document.getElementsByClassName('ataque-vida-user')
                const cardUser = document.getElementsByClassName('card-user')
                if (cardUser.length > 0) {
                    for (let i = cardUser.length; i >= 0; i--) {
                        data.cartas.cartasCombate.forEach(async (card) =>{
                            if (cardUser[i]) {
                                if (parseInt(cardUser[i].id) === card.id_carta) {
                                    if (card.vida <= 0) {
                                        cardUser[i].remove()
                                    } else {
                                        ataqueVidaUser[i].textContent = card.ataque + '/' + card.vida
                                    }
                                }
                            }
                        })
                    }
                }
                
                for (let i = 0; i < cardUser.length; i++) {
                    const buttonAtaque = document.createElement('button')
                    buttonAtaque.className = 'attack'
                    buttonAtaque.addEventListener('click', () => {
                        data.cartas.cartasCombate.forEach(card => {
                            if (specialAttackCard.length === 1) {
                                const tipo = specialAttackCard[0].tipo.split('/')
                                if (tipo[1] === 'aliado' && card.id_carta !== specialAttackCard[0].id) {
                                    console.log('Vida', card.vida)
                                    socket.emit('special-attack-ally', { idCartaAttacked: card.id_carta, idCartaAttacking: specialAttackCard[0].id, idAtaque: specialAttackCard[0].idAtaque, username: localStorage.getItem('username'), tipo: specialAttackCard[0].tipo })
                                    specialAttackCard = []
                                    const userCards = document.getElementsByClassName('card-user')
                                    for (let i = 0; i < userCards.length; i++) {
                                        userCards[i].style.boxShadow = 'none'
                                    }
                                } else if (tipo === 'revive') {
                                    if (card.vida <= 0 && card.id_carta !== specialAttackCard[0].id) {
                                        console.log('Vida', card.vida)
                                        socket.emit('special-attack-revive', { idCartaAttacked: card.id_carta, idCartaAttacking: specialAttackCard[0].id, idAtaque: specialAttackCard[0].idAtaque, username: localStorage.getItem('username'), tipo: specialAttackCard[0].tipo })
                                        specialAttackCard = []
                                        const userCards = document.getElementsByClassName('card-user')
                                        for (let i = 0; i < userCards.length; i++) {
                                            userCards[i].style.boxShadow = 'none'
                                        }
                                    } else {
                                        const userCardsRevive = document.getElementsByClassName('card-user-revive')
                                        for (let i = userCardsRevive.length - 1; i >= 0; i--) {
                                            userCardsRevive[i].remove()
                                        }
                                        specialAttackCard = []
                                        console.log('Card id', card.id_carta)
                                        cardClicked = []
                                        cardClicked.push(card.id_carta)
                                        const opponentCards = document.getElementsByClassName('card-opponent')
                                        for (let i = 0; i < opponentCards.length; i++) {
                                            opponentCards[i].style.boxShadow = '0px 0px 7px 2px red'
                                            opponentCards[i].style.cursor = 'pointer'
                                        }
                                    }
                                }
                            } else {
                                if (parseInt(cardUser[i].id) === card.id_carta) {
                                    if (data.tipo === 'inmovil' || card.efecto_secundario === 'inmovil') {
                                        alert('This card is immobilized')
                                    } else {
                                        if (playedCardAttack.length !== 0) {
                                            alert('Ya has puesto cartas en el tablero, no puedes atacar')
                                        } else {
                                            if (cardClicked.length === 1) {
                                                cardClicked = []
                                            }
                                            cardClicked.push(card.id_carta)
                                            const opponentCards = document.getElementsByClassName('card-opponent')
                                            for (let i = 0; i < opponentCards.length; i++) {
                                                opponentCards[i].style.boxShadow = '0px 0px 7px 2px red'
                                                opponentCards[i].style.cursor = 'pointer'
                                            }
                                        }
                                    }
                                }   
                            }
                        })
                    })

                    data.cartas.cartasCombate.forEach((card, index) => {
                        if (data.cartas.ataques[index]) {
                            if (card.id_carta === parseInt(cardUser[i].id) && card.ataque_especial === 0) {
                                const ataqueEspecialButton = document.createElement('button')
                                ataqueEspecialButton.className = 'ataque-especial-button'
                                ataqueEspecialButton.textContent = data.cartas.ataques[index].nombre
                                ataqueEspecialButton.addEventListener('click', () => {
                                    if (specialAttackCard.length === 1) {
                                        if (card.id_carta !== specialAttackCard[0].id) {
                                            const tipoSplit = specialAttackCard[0].tipo.split('/')
                                            if (tipoSplit[0] === 'revive'){
                                                const userCardsRevive = document.getElementsByClassName('card-user-revive')
                                                for (let i = userCardsRevive.length - 1; i >= 0; i--) {
                                                    userCardsRevive[i].remove()
                                                }
                                            } else if (tipoSplit[0] !== 'revive' && data.cartas.ataques[index].tipo === 'revive') {
                                                const opponentCards = document.getElementsByClassName('card-opponent')
                                                for (let i = opponentCards.length - 1; i >= 0; i--) {
                                                    opponentCards[i].style.boxShadow = 'none'
                                                    opponentCards[i].style.cursor = 'pointer'
                                                }
                                            }
                                            specialAttackCard = []
                                            if (data.cartas.ataques[index].tipo === 'area' || tipoSplit[1] === 'area') {
                                                socket.emit('special-attack-area', { idCartaAttacking: card.id_carta, idAtaque: data.cartas.ataques[index].id, username: localStorage.getItem('username'), tipo: data.cartas.ataques[index].tipo })
                                            } else if (data.cartas.ataques[index].tipo === 'power-up' || data.cartas.ataques[index].tipo === 'inmune' || data.cartas.ataques[index].tipo === 'reverse' && tipoSplit[1] !== 'aliado') {
                                                socket.emit('special-attack-self', { idCartaAttacking: card.id_carta, idAtaque: data.cartas.ataques[index].id, username: localStorage.getItem('username'), tipo: data.cartas.ataques[index].tipo })
                                            } else {
                                                specialAttackCard.push({
                                                    id: card.id_carta,
                                                    idAtaque: data.cartas.ataques[index].id,
                                                    tipo: data.cartas.ataques[index].tipo
                                                })
                                                if (tipoSplit[1] && tipoSplit[1] === 'aliado') {
                                                    const userCards = document.getElementsByClassName('card-user')
                                                    for (let i = 0; i < userCards.length; i++) {
                                                        if (parseInt(userCards[i].id) !== card.id_carta) {
                                                            userCards[i].style.boxShadow = '0px 0px 7px 4px green'
                                                        }
                                                    }
                                                } else {
                                                    const opponentCards = document.getElementsByClassName('card-opponent')
                                                    if (data.cartas.ataques[index].tipo === 'unico') {
                                                        for (let i = 0; i < opponentCards.length; i++) {
                                                            opponentCards[i].style.boxShadow = '0px 0px 7px 4px #901616'
                                                            opponentCards[i].style.cursor = 'pointer'
                                                        }
                                                    } else if (data.cartas.ataques[index].tipo === 'power-down') {
                                                        for (let i = 0; i < opponentCards.length; i++) {
                                                            opponentCards[i].style.boxShadow = '0px 0px 7px 4px #F34F4F'
                                                            opponentCards[i].style.cursor = 'pointer'
                                                        }
                                                    } else if (data.cartas.ataques[index].tipo === 'corrosivo') {
                                                        for (let i = 0; i < opponentCards.length; i++) {
                                                            opponentCards[i].style.boxShadow = '0px 0px 7px 4px #B83BDA'
                                                            opponentCards[i].style.cursor = 'pointer'
                                                        }
                                                    } else if (data.cartas.ataques[index].tipo === 'inmovil') {
                                                        for (let i = 0; i < opponentCards.length; i++) {
                                                            opponentCards[i].style.boxShadow = '0px 0px 7px 4px #C6C4C7'
                                                            opponentCards[i].style.cursor = 'pointer'
                                                        }
                                                    }  else if (data.cartas.ataques[index].tipo === 'revive') {
                                                        const userBoard = document.getElementsByClassName('user-board')[0]
                                                        data.cartas.cartasCombate.forEach((cardRevive, index) => {
                                                            if (cardRevive.vida === 0) {
                                                                const cardDiv = document.createElement('div')
                                                                cardDiv.className = 'card card-user card-user-revive'
                                                                cardDiv.style.backgroundImage = `url(${data.cartas.cartasInfo[index].foto})`
                                                                cardDiv.style.backgroundSize = 'contain'
                                                                cardDiv.style.backgroundRepeat = 'no-repeat'
                                                                cardDiv.style.backgroundPosition = 'center'
                                                                cardDiv.id = cardRevive.id_carta
                                                                cardDiv.style.boxShadow = '0px 0px 7px 4px #181818'
                                                                cardDiv.addEventListener('mouseover', () => {
                                                                    const informacionDiv = document.getElementsByClassName('informacion')[0]
                                                                    informacionDiv.style.display = 'flex'

                                                                    if (document.getElementsByClassName('name')[0]) {
                                                                        const name = document.getElementsByClassName('name')[0]
                                                                        name.remove()
                                                                    }

                                                                    const nombreCarta = document.createElement('p')
                                                                    nombreCarta.textContent = data.cartas.cartasInfo[index].nombre
                                                                    nombreCarta.className = 'name'

                                                                    informacionDiv.appendChild(nombreCarta)

                                                                    if (data.cartas.ataques[index]) {
                                                                        if (document.getElementsByClassName('ataque-especial-info')[0]) {
                                                                            const ataqueEspecialInfo = document.getElementsByClassName('ataque-especial-info')[0]
                                                                            ataqueEspecialInfo.remove()
                                                                        }
                                                                        const ataqueEspecialInfo = document.createElement('p')
                                                                        ataqueEspecialInfo.textContent = data.cartas.ataques[index].nombre + ' - ' + data.cartas.ataques[index].descripcion
                                                                        ataqueEspecialInfo.className = 'ataque-especial-info'

                                                                        informacionDiv.appendChild(ataqueEspecialInfo)
                                                                    }

                                                                    if (document.getElementsByClassName('ataque-vida-info')[0]) {
                                                                        const ataqueVidaInfo = document.getElementsByClassName('ataque-vida-info')[0]
                                                                        ataqueVidaInfo.remove()
                                                                    }

                                                                    const ataqueVidaInfo = document.createElement('p')
                                                                    ataqueVidaInfo.textContent = data.cartas.cartasCombate[index].ataque + '/' + data.cartas.cartasCombate[index].vida
                                                                    ataqueVidaInfo.className = 'ataque-vida-info'

                                                                    informacionDiv.appendChild(ataqueVidaInfo)
                                                                })

                                                                cardDiv.addEventListener('mouseout', () => {
                                                                    const informacionDiv = document.getElementsByClassName('informacion')[0]
                                                                    informacionDiv.style.display = 'none'
                                                                    const name = document.getElementsByClassName('name')[0]
                                                                    if (data.cartas.ataques[index]) {
                                                                        const ataqueEspecialInfo = document.getElementsByClassName('ataque-especial-info')[0]
                                                                        ataqueEspecialInfo.remove()
                                                                    }
                                                                    const ataqueVidaInfo = document.getElementsByClassName('ataque-vida-info')[0]
                                                                    name.remove()
                                                                    ataqueVidaInfo.remove()
                                                                })

                                                                cardDiv.addEventListener('click', () => {
                                                                    if (specialAttackCard.length === 1 && specialAttackCard[0].tipo === 'revive') {
                                                                        console.log('id carta reviviendo', cardRevive.id_carta)
                                                                        socket.emit('special-attack-revive', { idCartaAttacked: cardRevive.id_carta, idCartaAttacking: specialAttackCard[0].id, idAtaque: specialAttackCard[0].idAtaque, username: localStorage.getItem('username') })
                                                                    }
                                                                })

                                                                const cardName = document.createElement('p')
                                                                cardName.textContent = data.cartas.cartasInfo[index].nombre
                                                                cardName.className = 'cardName'

                                                                const ataqueVida = document.createElement('p')
                                                                ataqueVida.textContent = cardRevive.ataque + '/' + cardRevive.vida
                                                                ataqueVida.className = 'ataque-vida'

                                                                if (data.cartas.ataques[index]) {
                                                                    const ataqueEspecial = document.createElement('p')
                                                                    ataqueEspecial.textContent = data.cartas.ataques[index].nombre + ' - ' + data.cartas.ataques[index].descripcion
                                                                    ataqueEspecial.className = 'ataque-especial'

                                                                    cardDiv.appendChild(ataqueEspecial)
                                                                }

                                                                cardDiv.appendChild(cardName)
                                                                cardDiv.appendChild(ataqueVida)
                                                                userBoard.appendChild(cardDiv)
                                                            }
                                                        })
                                                    }
                                                }
                                            }
                                        }
                                    } else {
                                        if (parseInt(cardUser[i].id) === card.id_carta) {
                                            if (data.tipo === 'inmovil' || card.efecto_secundario === 'inmovil') {
                                                alert('This card is immobilized')
                                            } else {
                                                const tipoSplit = data.cartas.ataques[index].tipo.split('/')
                                                if (data.cartas.ataques[index].tipo === 'area' || tipoSplit[1] === 'area') {
                                                    socket.emit('special-attack-area', { idCartaAttacking: card.id_carta, idAtaque: data.cartas.ataques[index].id, username: localStorage.getItem('username'), tipo: data.cartas.ataques[index].tipo })
                                                } else if (data.cartas.ataques[index].tipo === 'power-up' || data.cartas.ataques[index].tipo === 'inmune' || data.cartas.ataques[index].tipo === 'reverse' && tipoSplit[1] !== 'aliado') {
                                                    socket.emit('special-attack-self', { idCartaAttacking: card.id_carta, idAtaque: data.cartas.ataques[index].id, username: localStorage.getItem('username'), tipo: data.cartas.ataques[index].tipo })
                                                } else {
                                                    specialAttackCard.push({
                                                        id: card.id_carta,
                                                        idAtaque: data.cartas.ataques[index].id,
                                                        tipo: data.cartas.ataques[index].tipo
                                                    })
                                                    if (tipoSplit[1] && tipoSplit[1] === 'aliado') {
                                                        const userCards = document.getElementsByClassName('card-user')
                                                        for (let i = 0; i < userCards.length; i++) {
                                                            if (parseInt(userCards[i].id) !== card.id_carta) {
                                                                userCards[i].style.boxShadow = '0px 0px 7px 4px green'
                                                            }
                                                        }
                                                    } else {
                                                        const opponentCards = document.getElementsByClassName('card-opponent')
                                                        if (data.cartas.ataques[index].tipo === 'unico') {
                                                            for (let i = 0; i < opponentCards.length; i++) {
                                                                opponentCards[i].style.boxShadow = '0px 0px 7px 4px #901616'
                                                                opponentCards[i].style.cursor = 'pointer'
                                                            }
                                                        } else if (data.cartas.ataques[index].tipo === 'power-down') {
                                                            for (let i = 0; i < opponentCards.length; i++) {
                                                                opponentCards[i].style.boxShadow = '0px 0px 7px 4px #F34F4F'
                                                                opponentCards[i].style.cursor = 'pointer'
                                                            }
                                                        } else if (data.cartas.ataques[index].tipo === 'corrosivo') {
                                                            for (let i = 0; i < opponentCards.length; i++) {
                                                                opponentCards[i].style.boxShadow = '0px 0px 7px 4px #B83BDA'
                                                                opponentCards[i].style.cursor = 'pointer'
                                                            }
                                                        } else if (data.cartas.ataques[index].tipo === 'inmovil') {
                                                            for (let i = 0; i < opponentCards.length; i++) {
                                                                opponentCards[i].style.boxShadow = '0px 0px 7px 4px #C6C4C7'
                                                                opponentCards[i].style.cursor = 'pointer'
                                                            }
                                                        }  else if (data.cartas.ataques[index].tipo === 'revive') {
                                                            const userBoard = document.getElementsByClassName('user-board')[0]
                                                            data.cartas.cartasCombate.forEach((cardRevive, index) => {
                                                                if (cardRevive.vida === 0) {
                                                                    const cardDiv = document.createElement('div')
                                                                    cardDiv.className = 'card card-user card-user-revive'
                                                                    cardDiv.style.backgroundImage = `url(${data.cartas.cartasInfo[index].foto})`
                                                                    cardDiv.style.backgroundSize = 'contain'
                                                                    cardDiv.style.backgroundRepeat = 'no-repeat'
                                                                    cardDiv.style.backgroundPosition = 'center'
                                                                    cardDiv.id = cardRevive.id_carta
                                                                    cardDiv.style.boxShadow = '0px 0px 7px 4px #181818'
                                                                    cardDiv.addEventListener('mouseover', () => {
                                                                        const informacionDiv = document.getElementsByClassName('informacion')[0]
                                                                        informacionDiv.style.display = 'flex'

                                                                        if (document.getElementsByClassName('name')[0]) {
                                                                            const name = document.getElementsByClassName('name')[0]
                                                                            name.remove()
                                                                        }

                                                                        const nombreCarta = document.createElement('p')
                                                                        nombreCarta.textContent = data.cartas.cartasInfo[index].nombre
                                                                        nombreCarta.className = 'name'

                                                                        informacionDiv.appendChild(nombreCarta)

                                                                        if (data.cartas.ataques[index]) {
                                                                            if (document.getElementsByClassName('ataque-especial-info')[0]) {
                                                                                const ataqueEspecialInfo = document.getElementsByClassName('ataque-especial-info')[0]
                                                                                ataqueEspecialInfo.remove()
                                                                            }
                                                                            const ataqueEspecialInfo = document.createElement('p')
                                                                            ataqueEspecialInfo.textContent = data.cartas.ataques[index].nombre + ' - ' + data.cartas.ataques[index].descripcion
                                                                            ataqueEspecialInfo.className = 'ataque-especial-info'

                                                                            informacionDiv.appendChild(ataqueEspecialInfo)
                                                                        }

                                                                        if (document.getElementsByClassName('ataque-vida-info')[0]) {
                                                                            const ataqueVidaInfo = document.getElementsByClassName('ataque-vida-info')[0]
                                                                            ataqueVidaInfo.remove()
                                                                        }

                                                                        const ataqueVidaInfo = document.createElement('p')
                                                                        ataqueVidaInfo.textContent = data.cartas.cartasCombate[index].ataque + '/' + data.cartas.cartasCombate[index].vida
                                                                        ataqueVidaInfo.className = 'ataque-vida-info'

                                                                        informacionDiv.appendChild(ataqueVidaInfo)
                                                                    })

                                                                    cardDiv.addEventListener('mouseout', () => {
                                                                        const informacionDiv = document.getElementsByClassName('informacion')[0]
                                                                        informacionDiv.style.display = 'none'
                                                                        const name = document.getElementsByClassName('name')[0]
                                                                        if (data.cartas.ataques[index]) {
                                                                            const ataqueEspecialInfo = document.getElementsByClassName('ataque-especial-info')[0]
                                                                            ataqueEspecialInfo.remove()
                                                                        }
                                                                        const ataqueVidaInfo = document.getElementsByClassName('ataque-vida-info')[0]
                                                                        name.remove()
                                                                        ataqueVidaInfo.remove()
                                                                    })

                                                                    cardDiv.addEventListener('click', () => {
                                                                        if (specialAttackCard.length === 1 && specialAttackCard[0].tipo === 'revive') {
                                                                            console.log('id carta reviviendo', cardRevive.id_carta)
                                                                            socket.emit('special-attack-revive', { idCartaAttacked: cardRevive.id_carta, idCartaAttacking: specialAttackCard[0].id, idAtaque: specialAttackCard[0].idAtaque, username: localStorage.getItem('username') })
                                                                        }
                                                                    })

                                                                    const cardName = document.createElement('p')
                                                                    cardName.textContent = data.cartas.cartasInfo[index].nombre
                                                                    cardName.className = 'cardName'

                                                                    const ataqueVida = document.createElement('p')
                                                                    ataqueVida.textContent = cardRevive.ataque + '/' + cardRevive.vida
                                                                    ataqueVida.className = 'ataque-vida'

                                                                    if (data.cartas.ataques[index]) {
                                                                        const ataqueEspecial = document.createElement('p')
                                                                        ataqueEspecial.textContent = data.cartas.ataques[index].nombre + ' - ' + data.cartas.ataques[index].descripcion
                                                                        ataqueEspecial.className = 'ataque-especial'

                                                                        cardDiv.appendChild(ataqueEspecial)
                                                                    }

                                                                    cardDiv.appendChild(cardName)
                                                                    cardDiv.appendChild(ataqueVida)
                                                                    userBoard.appendChild(cardDiv)
                                                                }
                                                            })
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                })
                                cardUser[i].appendChild(ataqueEspecialButton)
                            }
                        }
                    })
                    cardUser[i].appendChild(buttonAtaque)
                }
            }
        })

        socket.on('game-over', (data) => {
            if (data.winner === localStorage.getItem('username')) {
                const gameOver = document.getElementsByClassName('game-over')[0]
                gameOver.style.display = 'flex'
                const winner = document.getElementById('winner')
                winner.textContent = 'You win'
                winner.classList.add('winner')
                const recompensaText = document.getElementsByClassName('recompensa-text')[0]
                recompensaText.textContent = 'Reward: ' + data.recompensaWinner
                localStorage.setItem('winner', data.winner)
                localStorage.setItem('recompensaWinner', data.recompensaWinner)
            } else if (data.loser === localStorage.getItem('username')) {
                const gameOver = document.getElementsByClassName('game-over')[0]
                gameOver.style.display = 'flex'
                const winner = document.getElementById('winner')
                winner.textContent = 'You lost'
                winner.classList.add('loser')
                const recompensaText = document.getElementsByClassName('recompensa-text')[0]
                recompensaText.textContent = 'Reward: ' + data.recompensaLoser
                localStorage.setItem('loser', data.loser)
                localStorage.setItem('recompensaLoser', data.recompensaLoser)
            }
        })

        socket.on('left-match', (data) => {
            if (data.username === localStorage.getItem('username')) {
                localStorage.removeItem('opponent')
                localStorage.removeItem('winner')
                localStorage.removeItem('recompensaWinner')
                localStorage.removeItem('loser')
                localStorage.removeItem('recompensaLoser')
                window.location.href = '/'
            } else if (data.username === localStorage.getItem('opponent')) {
                if (document.getElementsByClassName('recompensa-text')[0]) {
                    const rewardSplit = document.getElementsByClassName('recompensa-text')[0].textContent.split(' ')
                    console.log('Reward', rewardSplit[1])
                    socket.emit('leave-battle', { username: localStorage.getItem('username'), reward: parseInt(rewardSplit[1]) })
                }
                localStorage.removeItem('opponent')
                localStorage.removeItem('winner')
                localStorage.removeItem('recompensaWinner')
                localStorage.removeItem('loser')
                localStorage.removeItem('recompensaLoser')
                window.location.href = '/'
            }
        })

        socket.on('left-battle', (data) => {
            if (data.username === localStorage.getItem('username')) {
                localStorage.removeItem('opponent')
                localStorage.removeItem('winner')
                localStorage.removeItem('recompensaWinner')
                localStorage.removeItem('loser')
                localStorage.removeItem('recompensaLoser')
                window.location.href = '/'
            }
        })
    </script>
</head>
<body>
    <div id="orientation-warning" class="hidden">
        <p>Por favor, gira tu dispositivo para jugar en modo horizontal.</p>
    </div>

    <div id="game-content">
    <form action="" method="post" class="leave-match">
        <button type="submit" id="leave-match">Leave Match</button>
    </form>
    <h3 id="turno"></h3>
    <div class="opponent"></div>

    <div class="board">
        <div class="opponent-board"></div>
        <div class="user-board" ondragover="dragOver(event)" ondrop="drop(event)"></div>
    </div>

    <div class="cards">
        <div class="user"></div>
        
        <div class="yourCards"></div>

    </div>
    <div class="informacion">
    </div>

    <form action="" method="post" class="end-turn">
        <button type="submit" id="end-turn">End Turn</button>
    </form>

    <div class="game-over">
        <div class="game-over-container">
            <h1>Match Ended</h1>
            <h2 id="winner"></h2>
            <div class="recompensa">
                <p class="recompensa-text"></p>
            </div>
            <form action="" method="post" class="leave-battle">
                <button type="submit" id="leave">Leave</button>
            </form>
        </div> 
    </div>
</div>
    <audio id="audio" src="img/[Non Copyrighted Music] @ScottBuckley - Phoenix [Epic].mp3" autoplay loop></audio>
    <script src="js/game.js"></script>
</body>
</html>