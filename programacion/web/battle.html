<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle - Chamous</title>
    <link rel="stylesheet" href="css/combat.css">
    <script type="module">
        import { io } from 'https://cdn.socket.io/4.7.5/socket.io.esm.min.js'

        const socket = io()

        const username = localStorage.getItem('username')

        if (!username && !localStorage.getItem('password')) {
            window.location.href = '/login'
        } else if (username && localStorage.getItem('password')) {
            fetch(`/checkUser?username=${username}&password=${localStorage.getItem('password')}`)
                .then(response => response.json())
                .then(data => {
                    if (data.message !== 'userExists') {
                        localStorage.removeItem('username')
                        localStorage.removeItem('password')
                        localStorage.removeItem('id')
                        window.location.href = '/login'
                    }
                })
        }

        function dragStart(event) {
            event.dataTransfer.setData('text', event.target.id)
            console.log(event.target.id)
        }

        function drop(event) {
            event.preventDefault()
            const data = event.dataTransfer.getData('text')
            console.log(data)
            const user = localStorage.getItem('username')

            socket.emit('playCard', { id: data, user })

            socket.on('played-card', (data) => {
                console.log(data)
                // Hacer que se muestre la carta en el board del user
            })

            socket.on('not-in-match', () => {
                console.log('You are not in a match')
            })

            socket.on('card-not-deck', () => {
                console.log('You do not have that card in your deck')
            })

            socket.on('not-your-turn', () => {
                console.log('It is not your turn')
                // Hay que hacer la comprovacion de los turnos y el cambio entre estos
            })
        }

        function dragOver(event) {
            event.preventDefault()
        }

        window.onload = () => {
            fetch(`getCardsBattle?id=${localStorage.getItem('id')}`)
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                    /*Board*/
                    const opponentBoard = document.getElementsByClassName('opponent-board')[0]
                    if (data.cartasCombates.cartasOpponent) {
                        const cartasOpponent = data.cartasCombates.cartasOpponent
                        cartasOpponent.forEach(card => {
                            const cardDiv = document.createElement('div')
                            cardDiv.className = 'card'
                            cardDiv.style.backgroundImage = `url(${card.cartaEnCombateOpponent.foto})`
                            cardDiv.style.backgroundSize = 'contain'
                            cardDiv.style.backgroundRepeat = 'no-repeat'
                            cardDiv.style.backgroundPosition = 'center'
                            cardDiv.id = card.cartaEnCombateOpponent.id
                            cardDiv.draggable = true
                            cardDiv.setAttribute('ondragstart', 'dragStart(event)')

                            const cardName = document.createElement('p')
                            cardName.textContent = card.cartaEnCombateOpponent.nombre
                            cardName.className = 'cardName'

                            const ataqueVida = document.createElement('p')
                            ataqueVida.textContent = card.cartaEnCombateOpponent.ataque + '/' + card.cartaEnCombateOpponent.vida
                            ataqueVida.className = 'ataque-vida'

                            if (card.ataque) {
                                const ataqueEspecial = document.createElement('p')
                                ataqueEspecial.textContent = card.ataque.nombre + ' - ' + card.ataque.descripcion
                                ataqueEspecial.className = 'ataque-especial'

                                cardDiv.appendChild(ataqueEspecial)
                            }

                            cardDiv.appendChild(cardName)
                            cardDiv.appendChild(ataqueVida)
                            opponentBoard.appendChild(cardDiv)
                        })
                    }

                    const userBoard = document.getElementsByClassName('user-board')[0]
                    if (data.cartasCombates.cartasUser) {
                        const cartasUser = data.cartasCombates.cartasUser
                        console.log(data.userDeckCards)
                        const userDeckId = data.userDeckCards.map(card => card.carta.id)
                        cartasUser.forEach(card => {
                            const cardDiv = document.createElement('div')
                            if (userDeckId.includes(card.cartaEnCombateUser.id)) {
                                console.log(data.userDeckCards[userDeckId.indexOf(card.cartaEnCombateUser.id)])
                                data.userDeckCards.splice(userDeckId.indexOf(card.cartaEnCombateUser.id), 1)
                                userDeckId.splice(userDeckId.indexOf(card.cartaEnCombateUser.id), 1)
                                console.log(data.userDeckCards)
                                console.log(userDeckId)
                            }
                            cardDiv.className = 'card'
                            cardDiv.style.backgroundImage = `url(${card.cartaEnCombateUser.foto})`
                            cardDiv.style.backgroundSize = 'contain'
                            cardDiv.style.backgroundRepeat = 'no-repeat'
                            cardDiv.style.backgroundPosition = 'center'
                            cardDiv.id = card.cartaEnCombateUser.id
                            cardDiv.draggable = true
                            cardDiv.setAttribute('ondragstart', 'dragStart(event)')

                            const cardName = document.createElement('p')
                            cardName.textContent = card.cartaEnCombateUser.nombre
                            cardName.className = 'cardName'

                            const ataqueVida = document.createElement('p')
                            ataqueVida.textContent = card.cartaEnCombateUser.ataque + '/' + card.cartaEnCombateUser.vida
                            ataqueVida.className = 'ataque-vida'

                            if (card.ataque) {
                                const ataqueEspecial = document.createElement('p')
                                ataqueEspecial.textContent = card.ataque.nombre + ' - ' + card.ataque.descripcion
                                ataqueEspecial.className = 'ataque-especial'

                                cardDiv.appendChild(ataqueEspecial)
                            }

                            cardDiv.appendChild(cardName)
                            cardDiv.appendChild(ataqueVida)
                            userBoard.appendChild(cardDiv)
                        })
                    }

                    /*Datos usuarios*/
                    const opponent = document.getElementsByClassName('opponent')[0]

                    const opponentProfilePicture = document.createElement('img')
                    opponentProfilePicture.src = data.opponent.foto_perfil
                    opponentProfilePicture.alt = 'Profile Picture', data.opponent.user
                    opponentProfilePicture.classList.add('profile-picture-opponent')

                    const opponentUsername = document.createElement('p')
                    opponentUsername.textContent = data.opponent.user
                    opponentUsername.classList.add('username-opponent')

                    opponent.appendChild(opponentProfilePicture)
                    opponent.appendChild(opponentUsername)

                    const user = document.getElementsByClassName('user')[0]

                    const profilePicture = document.createElement('img')
                    profilePicture.src = data.user.foto_perfil
                    profilePicture.alt = 'Profile Picture', data.user.user
                    profilePicture.classList.add('profile-picture')

                    const username = document.createElement('p')
                    username.textContent = data.user.user
                    username.classList.add('username')

                    user.appendChild(profilePicture)
                    user.appendChild(username)

                    const yourCards = document.getElementsByClassName('yourCards')[0]

                    data.userDeckCards.forEach(card => {
                        const cardDiv = document.createElement('div')
                        cardDiv.className = 'card'
                        cardDiv.style.backgroundImage = `url(${card.carta.foto})`
                        cardDiv.style.backgroundSize = 'contain'
                        cardDiv.style.backgroundRepeat = 'no-repeat'
                        cardDiv.style.backgroundPosition = 'center'
                        cardDiv.id = card.carta.id
                        cardDiv.draggable = true
                        cardDiv.setAttribute('ondragstart', 'dragStart(event)')

                        const cardName = document.createElement('p')
                        cardName.textContent = card.carta.nombre
                        cardName.className = 'cardName'

                        const ataqueVida = document.createElement('p')
                        ataqueVida.textContent = card.carta.ataque + '/' + card.carta.vida
                        ataqueVida.className = 'ataque-vida'

                        if (card.ataque) {
                            const ataqueEspecial = document.createElement('p')
                            ataqueEspecial.textContent = card.ataque.nombre + ' - ' + card.ataque.descripcion
                            ataqueEspecial.className = 'ataque-especial'

                            cardDiv.appendChild(ataqueEspecial)
                        }

                        cardDiv.appendChild(cardName)
                        cardDiv.appendChild(ataqueVida)
                        yourCards.appendChild(cardDiv)
                    })
                })
        }
    </script>
</head>
<body>
    <div class="opponent"></div>

    <div class="board">
        <div class="opponent-board"></div>
        <div class="user-board" ondragover="dragOver(event)" ondrop="drop(event)"></div>
    </div>

    <div class="cards">
        <div class="user"></div>
        
        <div class="yourCards"></div>

    </div>
    <script type="module" src="js/combat.js"></script>
</body>
</html>