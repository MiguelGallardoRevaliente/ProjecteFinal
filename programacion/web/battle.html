<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle - Chamous</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="css/combat.css">
    <script type="module">
        import { io } from 'https://cdn.socket.io/4.7.5/socket.io.esm.min.js'

        const socket = io()

        const username = localStorage.getItem('username')

        if (!username && !localStorage.getItem('password')) {
            window.location.href = '/login'
        } else if (username && localStorage.getItem('password')) {
            fetch(`/checkUser?username=${username}&password=${localStorage.getItem('password')}`)
                .then(response => response.json())
                .then(data => {
                    if (data.message !== 'userExists') {
                        localStorage.removeItem('username')
                        localStorage.removeItem('password')
                        localStorage.removeItem('id')
                        window.location.href = '/login'
                    }
                })
        }

        let cardClicked = []
        let playedCard = []
        window.onload = () => {
            fetch(`getCardsBattle?id=${localStorage.getItem('id')}`)
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                    /*Board*/
                    const opponentBoard = document.getElementsByClassName('opponent-board')[0]
                    if (data.cartasCombates.cartasOpponent) {
                        const cartasOpponent = data.cartasCombates.cartasOpponent
                        cartasOpponent.forEach(card => {
                            const cardDiv = document.createElement('div')
                            cardDiv.className = 'card card-opponent'
                            cardDiv.style.backgroundImage = `url(${card.cartaEnCombateOpponent.foto})`
                            cardDiv.style.backgroundSize = 'contain'
                            cardDiv.style.backgroundRepeat = 'no-repeat'
                            cardDiv.style.backgroundPosition = 'center'
                            cardDiv.id = card.cartaEnCombateOpponent.id
                            cardDiv.addEventListener('click', () => {
                                if (cardClicked.length === 1) {
                                    console.log('Pero bueno')
                                    socket.emit('attack', { cardAttacking: cardClicked[0], cardAttacked: card.cartaEnCombateOpponent.id, username: localStorage.getItem('username') })
                                }
                            })

                            const cardName = document.createElement('p')
                            cardName.textContent = card.cartaEnCombateOpponent.nombre
                            cardName.className = 'cardName'

                            const ataqueVida = document.createElement('p')
                            ataqueVida.textContent = card.cartaCombate.ataque + '/' + card.cartaCombate.vida
                            ataqueVida.className = 'ataque-vida ataque-vida-opponent'

                            if (card.ataque) {
                                const ataqueEspecial = document.createElement('p')
                                ataqueEspecial.textContent = card.ataque.nombre + ' - ' + card.ataque.descripcion
                                ataqueEspecial.className = 'ataque-especial ataque-especial-opponent'

                                cardDiv.appendChild(ataqueEspecial)
                            }

                            cardDiv.appendChild(cardName)
                            cardDiv.appendChild(ataqueVida)
                            opponentBoard.appendChild(cardDiv)
                        })
                    }

                    const userBoard = document.getElementsByClassName('user-board')[0]
                    if (data.cartasCombates.cartasUser) {
                        const cartasUser = data.cartasCombates.cartasUser
                        const userDeckId = data.userDeckCards.map(card => card.carta.id)
                        cartasUser.forEach(card => {
                            const cardDiv = document.createElement('div')
                            if (userDeckId.includes(card.cartaEnCombateUser.id)) {
                                data.userDeckCards.splice(userDeckId.indexOf(card.cartaEnCombateUser.id), 1)
                                userDeckId.splice(userDeckId.indexOf(card.cartaEnCombateUser.id), 1)
                            }
                            cardDiv.className = 'card card-user'
                            cardDiv.style.backgroundImage = `url(${card.cartaEnCombateUser.foto})`
                            cardDiv.style.backgroundSize = 'contain'
                            cardDiv.style.backgroundRepeat = 'no-repeat'
                            cardDiv.style.backgroundPosition = 'center'
                            cardDiv.id = card.cartaEnCombateUser.id

                            const cardName = document.createElement('p')
                            cardName.textContent = card.cartaEnCombateUser.nombre
                            cardName.className = 'cardName'

                            const ataqueVida = document.createElement('p')
                            ataqueVida.textContent = card.cartaCombate.ataque + '/' + card.cartaCombate.vida
                            ataqueVida.className = 'ataque-vida ataque-vida-user'

                            if (card.ataque) {
                                const ataqueEspecial = document.createElement('p')
                                ataqueEspecial.textContent = card.ataque.nombre + ' - ' + card.ataque.descripcion
                                ataqueEspecial.className = 'ataque-especial ataque-especial-user'

                                cardDiv.appendChild(ataqueEspecial)
                            }

                            if (data.combate.turno_uuid === data.user.id_uuid) {
                                const buttonAtaque = document.createElement('button')
                                buttonAtaque.textContent = 'Attack'
                                buttonAtaque.className = 'attack'
                                buttonAtaque.addEventListener('click', () => {
                                    console.log('Atacar')
                                    if (cardClicked.length === 1) cardClicked = []
                                    cardClicked.push(card.cartaEnCombateUser.id)
                                    console.log(cardClicked)
                                })

                                cardDiv.appendChild(buttonAtaque)
                            }
                            
                            cardDiv.appendChild(cardName)
                            cardDiv.appendChild(ataqueVida)
                            userBoard.appendChild(cardDiv)
                        })
                    }

                    /*Datos usuarios*/
                    // Oponente
                    const opponent = document.getElementsByClassName('opponent')[0]

                    const opponentProfilePicture = document.createElement('img')
                    opponentProfilePicture.src = data.opponent.foto_perfil
                    opponentProfilePicture.alt = 'Profile Picture', data.opponent.user
                    opponentProfilePicture.classList.add('profile-picture-opponent')

                    const opponentUsername = document.createElement('p')
                    opponentUsername.textContent = data.opponent.user
                    opponentUsername.classList.add('username-opponent')

                    opponent.appendChild(opponentProfilePicture)
                    opponent.appendChild(opponentUsername)

                    //Usuario
                    const user = document.getElementsByClassName('user')[0]

                    const profilePicture = document.createElement('img')
                    profilePicture.src = data.user.foto_perfil
                    profilePicture.alt = 'Profile Picture', data.user.user
                    profilePicture.classList.add('profile-picture')

                    const username = document.createElement('p')
                    username.textContent = data.user.user
                    username.classList.add('username')

                    if (data.user.id_uuid === data.combate.id_user_1_uuid) {
                        const manaDiv = document.createElement('div')
                        manaDiv.className = 'mana'

                        const manaImg = document.createElement('img')
                        manaImg.src = '/img/mana.png'
                        manaImg.style.border = 'none'

                        const mana = document.createElement('p')
                        mana.textContent = data.combate.mana_user_1
                        mana.id = 'mana-number'

                        manaDiv.appendChild(mana)
                        manaDiv.appendChild(manaImg)
                        user.appendChild(manaDiv)
                    } else if (data.user.id_uuid === data.combate.id_user_2_uuid) {
                        const manaDiv = document.createElement('div')
                        manaDiv.className = 'mana'

                        const manaImg = document.createElement('img')
                        manaImg.src = '/img/mana.png'
                        manaImg.style.border = 'none'

                        const mana = document.createElement('p')
                        mana.textContent = data.combate.mana_user_2
                        mana.id = 'mana-number'

                        manaDiv.appendChild(mana)
                        manaDiv.appendChild(manaImg)
                        user.appendChild(manaDiv)
                    }

                    user.appendChild(profilePicture)
                    user.appendChild(username)

                    // Turno
                    const turno = document.getElementById('turno')
                    if (data.combate.turno_uuid === data.user.id_uuid) {
                        turno.textContent = 'Turn: ' + data.user.user
                    } else if (data.combate.turno_uuid === data.opponent.id_uuid) {
                        turno.textContent = 'Turn: ' + data.opponent.user
                    }

                    const yourCards = document.getElementsByClassName('yourCards')[0]

                    /* Cartas del mazo del usuario */
                    data.userDeckCards.forEach(card => {
                        const cardDiv = document.createElement('div')
                        cardDiv.className = 'card card' + card.carta.id
                        cardDiv.style.backgroundImage = `url(${card.carta.foto})`
                        cardDiv.style.backgroundSize = 'contain'
                        cardDiv.style.backgroundRepeat = 'no-repeat'
                        cardDiv.style.backgroundPosition = 'center'
                        cardDiv.id = card.carta.id
                        cardDiv.addEventListener('click', () => {
                            if (playedCard.length === 0) {
                                const user = localStorage.getItem('username')
                                socket.emit('play-card', { id: card.carta.id, user })
                                playedCard.push(card.carta.id)
                            }
                        })

                        const cardName = document.createElement('p')
                        cardName.textContent = card.carta.nombre
                        cardName.className = 'cardName'

                        const ataqueVida = document.createElement('p')
                        ataqueVida.textContent = card.carta.ataque + '/' + card.carta.vida
                        ataqueVida.className = 'ataque-vida'

                        if (card.ataque) {
                            const ataqueEspecial = document.createElement('p')
                            ataqueEspecial.textContent = card.ataque.nombre + ' - ' + card.ataque.descripcion
                            ataqueEspecial.className = 'ataque-especial'

                            cardDiv.appendChild(ataqueEspecial)
                        }

                        cardDiv.appendChild(cardName)
                        cardDiv.appendChild(ataqueVida)
                        yourCards.appendChild(cardDiv)
                    })

                    if (data.combate.turno_uuid === data.user.id_uuid) {
                        const endTurnForm = document.getElementsByClassName('end-turn')[0]
                        endTurnForm.style.display = 'block'
                    } else {
                        const endTurnForm = document.getElementsByClassName('end-turn')[0]
                        endTurnForm.style.display = 'none'
                    }
                })
        }

        /* Formularios */
        const endTurnForm = document.getElementsByClassName('end-turn')[0]
        endTurnForm.addEventListener('submit', (event) => {
            event.preventDefault()
            console.log('End Turn')
            socket.emit('end-turn', { username: localStorage.getItem('username') })
        })

        const leaveMatchForm = document.getElementsByClassName('leave-match')[0]
        leaveMatchForm.addEventListener('submit', (event) => {
            event.preventDefault()
            console.log('Leave Match')
            socket.emit('leave-match', { username: localStorage.getItem('username') })
        })

        /* Recibir mensajes del servidor */
        socket.on('played-card', (data) => {
            playedCard = []
            const cardDivPlayed = document.createElement('div')
            if (data.user === localStorage.getItem('username')) {
                cardDivPlayed.className = 'card card.user'
            } else if (data.user === localStorage.getItem('opponent')) {
                cardDivPlayed.className = 'card card.opponent'
            }
            cardDivPlayed.style.backgroundImage = `url(${data.carta.foto})`
            cardDivPlayed.style.backgroundSize = 'contain'
            cardDivPlayed.style.backgroundRepeat = 'no-repeat'
            cardDivPlayed.style.backgroundPosition = 'center'
            cardDivPlayed.id = data.carta.id

            const cardNamePlayed = document.createElement('p')
            cardNamePlayed.textContent = data.carta.nombre
            cardNamePlayed.className = 'cardName'

            const ataqueVidaPlayed = document.createElement('p')
            ataqueVidaPlayed.textContent = data.carta.ataque + '/' + data.carta.vida
            ataqueVidaPlayed.className = 'ataque-vida'

            if (data.ataque) {
                const ataqueEspecialPlayed = document.createElement('p')
                ataqueEspecialPlayed.textContent = data.ataque.nombre + ' - ' + data.ataque.descripcion
                ataqueEspecialPlayed.className = 'ataque-especial'

                cardDivPlayed.appendChild(ataqueEspecialPlayed)
            }

            cardDivPlayed.appendChild(cardNamePlayed)
            cardDivPlayed.appendChild(ataqueVidaPlayed)

            if (data.user === localStorage.getItem('username')) {
                const buttonAtaque = document.createElement('button')
                buttonAtaque.textContent = 'Attack'
                buttonAtaque.className = 'attack'
                buttonAtaque.addEventListener('click', () => {
                    console.log('Atacar')
                    if (cardClicked.length === 1) cardClicked = []
                    cardClicked.push(parseInt(data.carta.id))
                    console.log(cardClicked)
                })

                cardDivPlayed.appendChild(buttonAtaque)

                const userBoard = document.getElementsByClassName('user-board')[0]
                userBoard.appendChild(cardDivPlayed)

                document.getElementsByClassName('card' + data.carta.id)[0].remove()

                const manaNumber = document.getElementById('mana-number')
                manaNumber.textContent = data.mana
            } else if (data.user === localStorage.getItem('opponent')) {
                cardDivPlayed.addEventListener('click', () => {
                    if (cardClicked.length === 1) {
                        console.log('Pero bueno')
                        socket.emit('attack', { cardAttacking: cardClicked[0], cardAttacked: data.carta.id, username: localStorage.getItem('username') })
                    }
                })
                const opponentBoard = document.getElementsByClassName('opponent-board')[0]
                opponentBoard.appendChild(cardDivPlayed)
            }
        })

        socket.on('not-enough-mana', (data) => {
            if (data.username === localStorage.getItem('username')) {
                alert('No tienes suficiente mana para jugar esa carta')
            }
        })

        socket.on('not-your-turn', (data) => {
            if (data.username === localStorage.getItem('username')) {
                alert('No es tu turno')
            }
        })

        socket.on('attacked', (data) => {
            console.log(data)
            console.log(data.opponent)
            console.log(localStorage.getItem('opponent'))
            console.log(data.opponent === localStorage.getItem('opponent'))
            if (data.opponent === localStorage.getItem('opponent')) {
                const cardOpponent = document.getElementsByClassName('card-opponent')
                console.log(cardOpponent.length)
                for (let i = 0; i < cardOpponent.length; i++) {
                    console.log(cardOpponent[i].id, data.cardAttacked.id)
                    if (parseInt(cardOpponent[i].id) === data.cardAttacked.id) {
                        const ataqueVida = document.getElementsByClassName('ataque-vida-opponent')[i]
                        let ataqueVidaText = ataqueVida.textContent.split('/')
                        ataqueVidaText = ataqueVidaText[0] + '/' + data.vida
                        console.log('Opponent attacked')
                        ////////////////// AQUI LO QUE HACE LA CARTA AL SER ATACADA //////////////////
                    }
                }
            } else if (data.opponent === localStorage.getItem('username')) {
                const cardUser = document.getElementsByClassName('card-user')
                for (let i = 0; i < cardUser.length; i++) {
                    if (cardUser[i].id === data.cardAttacked.id) {
                        const ataqueVida = document.getElementsByClassName('ataque-vida-user')[i]
                        let ataqueVidaText = ataqueVida.textContent.split('/')
                        ataqueVidaText = ataqueVidaText[0] + '/' + data.vida
                        console.log('User attacked')
                        ////////////////// AQUI LO QUE HACE LA CARTA AL SER ATACADA //////////////////
                    }
                }
            }
        })

        socket.on('ended-turn', (data) => {
            if (data.username === localStorage.getItem('username')) {
                cardClicked = []
                const turno = document.getElementById('turno')
                turno.textContent = 'Turn: ' + localStorage.getItem('opponent')
                const endTurnForm = document.getElementsByClassName('end-turn')[0]
                endTurnForm.style.display = 'none'

                const attacks = document.querySelectorAll('.attack');

                attacks.forEach(attack => {
                attack.remove()
                })
            } else if (data.username === localStorage.getItem('opponent')) {
                cardClicked = []
                const turno = document.getElementById('turno')
                turno.textContent = 'Turn: ' + localStorage.getItem('username')
                const endTurnForm = document.getElementsByClassName('end-turn')[0]
                endTurnForm.style.display = 'block'

                const cardUser = document.getElementsByClassName('card-user')
                for (let i = 0; i < cardUser.length; i++) {
                    const buttonAtaque = document.createElement('button')
                    buttonAtaque.textContent = 'Attack'
                    buttonAtaque.className = 'attack'
                    buttonAtaque.addEventListener('click', () => {
                        console.log('Atacar')
                        if (cardClicked.length === 1) cardClicked = []
                        cardClicked.push(parseInt(cardUser[i].id))
                        console.log(cardClicked)
                    })

                    cardUser[i].appendChild(buttonAtaque)
                }
            }
        })

        socket.on('left-match', (data) => {
            if (data.username === localStorage.getItem('username')) {
                alert('Has abandonado la partida')
                localStorage.removeItem('opponent')
                window.location.href = '/'
            } else if (data.username === localStorage.getItem('opponent')) {
                alert('Tu oponente ha abandonado la partida')
                localStorage.removeItem('opponent')
                window.location.href = '/'
            }
        })
    </script>
</head>
<body>
    <form action="" method="post" class="leave-match">
        <button type="submit" id="leave-match">Leave Match</button>
    </form>
    <h3 id="turno"></h3>
    <div class="opponent"></div>

    <div class="board">
        <div class="opponent-board"></div>
        <div class="user-board" ondragover="dragOver(event)" ondrop="drop(event)"></div>
    </div>

    <div class="cards">
        <div class="user"></div>
        
        <div class="yourCards"></div>

    </div>

    <form action="" method="post" class="end-turn">
        <button type="submit" id="end-turn">End Turn</button>
    </form>
    <audio id="audio" src="img/2-hours Epic Medieval Battle Music 2-horas de Musica Epica de Batalla medieval.mp3" autoplay loop></audio>
    <script src="js/game.js"></script>
</body>
</html>